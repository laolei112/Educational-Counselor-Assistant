# 插班信息格式兼容性说明

## 更新日期
2025-11-12

## 背景
为了支持更多样化的插班信息数据格式，特别是支持以下格式：

```json
{
  "插班": {
    "插班申请详情链接": "https://www.spps.edu.hk/attachment/upload/files/news/2526/%E6%8F%92%E7%8F%AD%E7%94%9F%20%E6%9C%80%E6%96%B0%E6%B6%88%E6%81%AF_27_10%E6%9B%B4%E6%96%B03.pdf",
    "插班申请开始时间1": "开放申请",
    "插班申请截止时间1": "2025-11-10 00:00:00"
  }
}
```

## 主要变更

### 1. 类型定义更新 (`frontend/src/types/school.ts`)
在 `TransferInfo.插班` 接口中添加了新字段：
- ✅ `插班申请详情链接?: string` - 兼容新格式的链接字段名

### 2. 字段名兼容性
系统现在同时支持两种链接字段名：
- `插班详情链接` (旧格式)
- `插班申请详情链接` (新格式)

优先级：优先使用 `插班申请详情链接`，如果不存在则使用 `插班详情链接`

### 3. 日期格式优化
改进了日期显示逻辑，特别是对于"开放申请"这类文本状态：

**示例：**
- 输入：`插班申请开始时间1: "开放申请"`, `插班申请截止时间1: "2025-11-10 00:00:00"`
- 显示：`截止 2025.11.10`

### 4. 状态判断（已修复截止时间检查）
`isCardOpen` 函数已支持识别以下文本状态，并正确处理截止时间：
- "开放申请"
- "开放中"

**重要修复**：
- ✅ 当开始时间为"开放申请"等文本状态时，会检查截止时间
- ✅ 如果截止时间已过，状态会正确显示为 "CLOSED"
- ✅ 只有在截止时间未过或没有截止时间的情况下，才会显示为 "OPEN"

**示例**：
```json
{
  "插班申请开始时间1": "开放申请",
  "插班申请截止时间1": "2025-11-10 00:00:00"
}
```
- 当前时间 < 2025-11-10：显示 "OPEN" ✅
- 当前时间 > 2025-11-10：显示 "CLOSED" ✅

## 支持的数据格式

### 格式 1：标准日期范围
```json
{
  "插班": {
    "插班申请开始时间1": "2025-01-01",
    "插班申请截止时间1": "2025-01-31",
    "插班详情链接": "https://example.com"
  }
}
```
显示：`2025.1.1-2025.1.31`

### 格式 2：文本状态 + 截止日期（新格式）
```json
{
  "插班": {
    "插班申请开始时间1": "开放申请",
    "插班申请截止时间1": "2025-11-10 00:00:00",
    "插班申请详情链接": "https://example.com"
  }
}
```
显示：`截止 2025.11.10`
状态：根据当前时间判断
- 当前时间 ≤ 2025-11-10：`OPEN`
- 当前时间 > 2025-11-10：`CLOSED`

### 格式 3：仅文本状态
```json
{
  "插班": {
    "插班申请开始时间1": "开放申请",
    "插班申请详情链接": "https://example.com"
  }
}
```
显示：`开放申请`
状态：`OPEN`

### 格式 4：每年固定时间
```json
{
  "插班": {
    "插班申请开始时间1": "每年9月1日",
    "插班详情链接": "https://example.com"
  }
}
```
显示：`每年9月1日`
状态：当前月份为9月时显示 `OPEN`

### 格式 5：多个时间段
```json
{
  "插班": {
    "插班申请开始时间1": "2025-01-01",
    "插班申请截止时间1": "2025-01-31",
    "可插班年级1": "一至三年级",
    "插班申请开始时间2": "2025-05-01",
    "插班申请截止时间2": "2025-05-31",
    "可插班年级2": "四至六年级",
    "插班申请详情链接": "https://example.com"
  }
}
```
显示：
```
插班一至三年级-2025.1.1-2025.1.31
插班四至六年级-2025.5.1-2025.5.31
```

## 技术实现

### 关键函数

1. **`getTransferDetailLink()`** - 获取插班详情链接
   - 优先使用 `插班申请详情链接`
   - 回退到 `插班详情链接`

2. **`hasValidTransferInfo()`** - 验证插班信息有效性
   - 检查是否有时间信息或链接
   - 兼容两种链接字段名

3. **`formatTransferDateRange()`** - 格式化日期范围
   - 智能识别文本状态（如"开放申请"）
   - 当开始时间为文本状态时，仅显示截止日期
   - 支持多时间段显示

4. **`isCardOpen()`** - 判断申请是否开放
   - 识别"开放申请"、"开放中"等文本
   - 检查日期范围
   - 支持"每年X月"格式

## 向后兼容性
✅ 完全向后兼容，所有旧格式数据继续正常工作
✅ 新旧字段名可以共存
✅ 优雅降级：如果新字段不存在，自动使用旧字段

## 测试建议
建议测试以下场景：
1. 仅有旧字段名的数据
2. 仅有新字段名的数据
3. 同时有新旧字段名的数据（应优先显示新字段）
4. "开放申请" + 截止日期的组合
5. 多个时间段的显示

