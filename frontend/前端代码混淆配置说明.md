# å‰ç«¯ä»£ç æ··æ·†é…ç½®è¯´æ˜

## ğŸ” ä¸ºä»€ä¹ˆéœ€è¦ä»£ç æ··æ·†ï¼Ÿ

### å½“å‰å®‰å…¨é£é™©

1. **ç­¾åç®—æ³•æš´éœ²**
   - `crypto.ts` ä¸­çš„ç­¾åç”Ÿæˆé€»è¾‘å¯è¢«æŸ¥çœ‹
   - æ”»å‡»è€…å¯ä»¥åˆ†æç®—æ³•ç»†èŠ‚

2. **APIå¯†é’¥æš´éœ²**
   - ç¯å¢ƒå˜é‡ `VITE_API_SECRET` ä¼šè¢«æ‰“åŒ…åˆ°JSä¸­
   - å¯é€šè¿‡æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹

3. **ä¸šåŠ¡é€»è¾‘æš´éœ²**
   - æ‰€æœ‰å‰ç«¯ä»£ç éƒ½æ˜¯æ˜æ–‡
   - æ”»å‡»è€…å¯ä»¥åˆ†æè¯·æ±‚æµç¨‹

### ä»£ç æ··æ·†çš„ä½œç”¨

âœ… **å¢åŠ é€†å‘å·¥ç¨‹éš¾åº¦** - å°†ä»£ç è½¬æ¢ä¸ºéš¾ä»¥é˜…è¯»çš„å½¢å¼  
âœ… **ä¿æŠ¤ä¸šåŠ¡é€»è¾‘** - éšè—ç®—æ³•å’Œå®ç°ç»†èŠ‚  
âœ… **å»¶ç¼“ç ´è§£æ—¶é—´** - æé«˜æ”»å‡»æˆæœ¬  
âš ï¸ **æ³¨æ„**ï¼šæ··æ·†ä¸èƒ½å®Œå…¨é˜²æ­¢ç ´è§£ï¼Œåªæ˜¯å¢åŠ éš¾åº¦

## ğŸ› ï¸ é…ç½®æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä½¿ç”¨ Terserï¼ˆæ¨èï¼Œæ›´å¼ºæ··æ·†ï¼‰

#### æ­¥éª¤1: å®‰è£…ä¾èµ–

```bash
cd frontend
npm install -D terser
```

#### æ­¥éª¤2: é…ç½®å·²å®Œæˆ

`vite.config.ts` å·²é…ç½®å¥½Terseræ··æ·†ï¼ˆå·²æ›´æ–°ï¼‰

**é…ç½®è¯´æ˜ï¼š**
- âœ… ç§»é™¤æ‰€æœ‰ console è¾“å‡º
- âœ… ç§»é™¤ debugger è¯­å¥
- âœ… æ··æ·†å˜é‡å
- âœ… ç§»é™¤æ³¨é‡Š
- âœ… å…³é—­ source mapï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- âœ… æ··æ·†æ–‡ä»¶åï¼ˆå¸¦hashï¼‰

### æ–¹æ¡ˆ2: ä½¿ç”¨ ESBuildï¼ˆé»˜è®¤ï¼Œå¿«é€Ÿï¼‰

å¦‚æœä¸æƒ³å®‰è£…é¢å¤–ä¾èµ–ï¼Œä½¿ç”¨ESBuildä¹Ÿå¯ä»¥ï¼š

```typescript
// vite.config.ts
export default defineConfig({
  // ...
  build: {
    minify: 'esbuild', // é»˜è®¤é€‰é¡¹
    rollupOptions: {
      output: {
        // æ··æ·†æ–‡ä»¶å
        chunkFileNames: 'assets/[name]-[hash].js',
        entryFileNames: 'assets/[name]-[hash].js',
        assetFileNames: 'assets/[name]-[hash].[ext]'
      }
    },
    sourcemap: false
  }
})
```

**å¯¹æ¯”ï¼š**
| ç‰¹æ€§ | Terser | ESBuild |
|------|--------|---------|
| æ··æ·†å¼ºåº¦ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜†â˜† |
| æ„å»ºé€Ÿåº¦ | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜…â˜… |
| æ–‡ä»¶å¤§å° | æ›´å° | ç¨å¤§ |
| æ¨èåœºæ™¯ | ç”Ÿäº§ç¯å¢ƒ | å¼€å‘æ„å»º |

## ğŸ”’ é¢å¤–å®‰å…¨æªæ–½

### 1. åŠ¨æ€å¯†é’¥ç”Ÿæˆï¼ˆæ¨èï¼‰

ä¸è¦å°†å®Œæ•´å¯†é’¥ç¡¬ç¼–ç åœ¨å‰ç«¯ï¼Œè€Œæ˜¯ä½¿ç”¨æ´¾ç”Ÿå¯†é’¥ï¼š

```typescript
// frontend/src/utils/crypto.ts

// ä¿®æ”¹å¯†é’¥è·å–æ–¹å¼
const BASE_SECRET = import.meta.env.VITE_API_SECRET || 'fallback'
const CLIENT_SALT = 'client-specific-salt-2024'

// æ´¾ç”Ÿå®é™…ä½¿ç”¨çš„å¯†é’¥
async function getDerivedSecret(): Promise<string> {
  const encoder = new TextEncoder()
  const keyMaterial = await crypto.subtle.importKey(
    'raw',
    encoder.encode(BASE_SECRET),
    { name: 'PBKDF2' },
    false,
    ['deriveBits']
  )
  
  const derivedBits = await crypto.subtle.deriveBits(
    {
      name: 'PBKDF2',
      salt: encoder.encode(CLIENT_SALT),
      iterations: 100000,
      hash: 'SHA-256'
    },
    keyMaterial,
    256
  )
  
  return btoa(String.fromCharCode(...new Uint8Array(derivedBits)))
}

// ä½¿ç”¨æ´¾ç”Ÿå¯†é’¥
const API_SECRET = await getDerivedSecret()
```

### 2. åˆ†ç¦»æ•æ„Ÿé€»è¾‘

å°†æœ€æ•æ„Ÿçš„ç­¾åéªŒè¯æ”¾åˆ°åç«¯ï¼š

```typescript
// å‰ç«¯åªå‘é€å‚æ•°ï¼Œä¸æš´éœ²ç­¾åç®—æ³•
export async function generateSignature(params: Record<string, any>) {
  // è°ƒç”¨åç«¯APIç”Ÿæˆç­¾å
  const response = await fetch('/api/generate-signature', {
    method: 'POST',
    body: JSON.stringify(params)
  })
  return response.json()
}
```

åç«¯å®ç°ï¼š
```python
# backend/api/signature/views.py
@require_http_methods(["POST"])
def generate_signature(request):
    """ç”Ÿæˆè¯·æ±‚ç­¾åï¼ˆä»…é™å¯ä¿¡æ¥æºï¼‰"""
    # éªŒè¯è¯·æ±‚æ¥æº
    # ç”Ÿæˆç­¾å
    # è¿”å›ç­¾å
    pass
```

### 3. ä»£ç åŠ å¯†ï¼ˆé«˜çº§ï¼‰

ä½¿ç”¨ `vite-plugin-obfuscator` è¿›è¡Œæ›´å¼ºçš„åŠ å¯†ï¼š

```bash
npm install -D vite-plugin-obfuscator
```

```typescript
// vite.config.ts
import { obfuscator } from 'vite-plugin-obfuscator'

export default defineConfig({
  plugins: [
    vue(),
    obfuscator({
      options: {
        compact: true,
        controlFlowFlattening: true,
        deadCodeInjection: true,
        debugProtection: true,
        debugProtectionInterval: true,
        disableConsoleOutput: true,
        identifierNamesGenerator: 'hexadecimal',
        rotateStringArray: true,
        selfDefending: true,
        stringArray: true,
        stringArrayEncoding: ['base64'],
        stringArrayThreshold: 0.75,
        unicodeEscapeSequence: false
      }
    })
  ]
})
```

### 4. ç¯å¢ƒå˜é‡ä¿æŠ¤

ä¸è¦åœ¨å‰ç«¯æš´éœ²æ•æ„Ÿå¯†é’¥ï¼Œä½¿ç”¨æœåŠ¡ç«¯ä»£ç†ï¼š

```typescript
// frontend/src/api/config.ts
export const API_CONFIG = {
  BASE_URL: '/api', // é€šè¿‡nginxä»£ç†
  TIMEOUT: 30000,
  HEADERS: {
    'Content-Type': 'application/json'
  }
  // ä¸åœ¨å‰ç«¯å­˜å‚¨ API_SECRET
}
```

```python
# backend åœ¨æœåŠ¡ç«¯ç®¡ç†å¯†é’¥
API_SECRET = os.environ.get('API_SECRET')
```

## ğŸ“¦ æ„å»ºå’Œéƒ¨ç½²

### æ„å»ºå‘½ä»¤

```bash
# å¼€å‘æ„å»ºï¼ˆä¸æ··æ·†ï¼Œæœ‰source mapï¼‰
npm run dev

# ç”Ÿäº§æ„å»ºï¼ˆæ··æ·†ï¼Œæ— source mapï¼‰
npm run build

# é¢„è§ˆç”Ÿäº§æ„å»º
npm run preview
```

### éªŒè¯æ··æ·†æ•ˆæœ

æ„å»ºåæ£€æŸ¥ï¼š

```bash
# æŸ¥çœ‹æ„å»ºäº§ç‰©
ls -lh dist/assets/

# æ£€æŸ¥JSæ–‡ä»¶æ˜¯å¦å·²æ··æ·†
cat dist/assets/index-*.js | head -20
```

**æ··æ·†åçš„ä»£ç ç‰¹å¾ï¼š**
- å˜é‡åè¢«æ›¿æ¢ä¸º a, b, c, t0, t1 ç­‰çŸ­åç§°
- æ²¡æœ‰æ³¨é‡Š
- æ²¡æœ‰console.log
- ä»£ç ç´§å‡‘ï¼Œéš¾ä»¥é˜…è¯»

### Dockeræ„å»º

```dockerfile
# frontend/Dockerfile
FROM node:18-alpine as builder

WORKDIR /app
COPY package*.json ./
RUN npm ci

COPY . .
# ç”Ÿäº§æ„å»ºä¼šè‡ªåŠ¨åº”ç”¨æ··æ·†
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
```

## ğŸ” æ··æ·†æ•ˆæœå¯¹æ¯”

### æ··æ·†å‰ï¼ˆæ˜æ–‡ï¼‰
```javascript
async function generateSignature(params, body) {
  const timestamp = getTimestamp()
  const nonce = generateNonce()
  const signString = `${timestamp}${nonce}${API_KEY}${sortAndStringify(params)}${body}${API_SECRET}`
  const signature = await sha256(signString)
  return { timestamp, nonce, signature }
}
```

### æ··æ·†åï¼ˆTerserï¼‰
```javascript
async function t(e,n){const r=o(),a=i(),s=await c(`${r}${a}${l}${u(e)}${n}${d}`);return{timestamp:r,nonce:a,signature:s}}
```

### é«˜å¼ºåº¦æ··æ·†åï¼ˆobfuscatorï¼‰
```javascript
var _0x4a2b=['timestamp','nonce','signature'];(function(_0x2d8f05,_0x4b81bb){var _0x4d74cb=function(_0x32719f){while(--_0x32719f){_0x2d8f05['push'](_0x2d8f05['shift']());}};_0x4d74cb(++_0x4b81bb);}(_0x4a2b,0x1a3));var _0x4d74=function(_0x2d8f05,_0x4b81bb){_0x2d8f05=_0x2d8f05-0x0;var _0x4d74cb=_0x4a2b[_0x2d8f05];return _0x4d74cb;};async function t(e,n){const r=o(),a=i(),s=await c(''[_0x4d74('0x0')](r)[_0x4d74('0x0')](a));return{[_0x4d74('0x0')]:r,[_0x4d74('0x1')]:a,[_0x4d74('0x2')]:s};}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ··æ·†çš„å±€é™æ€§

1. **ä¸æ˜¯ç»å¯¹å®‰å…¨** - æœ‰ç»éªŒçš„æ”»å‡»è€…ä»ç„¶å¯ä»¥ç ´è§£
2. **å¯èƒ½å½±å“æ€§èƒ½** - é«˜å¼ºåº¦æ··æ·†ä¼šå¢åŠ ä»£ç ä½“ç§¯
3. **è°ƒè¯•å›°éš¾** - æ··æ·†åçš„ä»£ç éš¾ä»¥è°ƒè¯•

### æœ€ä½³å®è·µ

âœ… **ç”Ÿäº§ç¯å¢ƒå¯ç”¨æ··æ·†** - å¿…é¡»  
âœ… **å…³é—­ source map** - é˜²æ­¢æºç æ³„éœ²  
âœ… **æ•æ„Ÿé€»è¾‘åç§»** - å…³é”®éªŒè¯åœ¨æœåŠ¡ç«¯  
âœ… **å®šæœŸæ›´æ–°å¯†é’¥** - å³ä½¿æ³„éœ²å½±å“ä¹Ÿæœ‰é™  
âœ… **ç›‘æ§å¼‚å¸¸è¯·æ±‚** - åŠæ—¶å‘ç°ç ´è§£å°è¯•  

### æ¨èé…ç½®

**ä¸€èˆ¬é¡¹ç›®ï¼ˆå¹³è¡¡ï¼‰ï¼š**
```typescript
build: {
  minify: 'terser',
  sourcemap: false
}
```

**é«˜å®‰å…¨é¡¹ç›®ï¼ˆå¼ºæ··æ·†ï¼‰ï¼š**
```typescript
build: {
  minify: 'terser',
  sourcemap: false,
  plugins: [obfuscator({ /* é«˜å¼ºåº¦é…ç½® */ })]
}
```

**å¿«é€Ÿå¼€å‘ï¼ˆæœ€å°ï¼‰ï¼š**
```typescript
build: {
  minify: 'esbuild',
  sourcemap: true // å¼€å‘æ—¶ä¿ç•™
}
```

## ğŸš€ å¿«é€Ÿåº”ç”¨

### ç«‹å³å¯ç”¨ï¼ˆæ¨èé…ç½®ï¼‰

1. **å®‰è£…Terser**
```bash
cd frontend
npm install -D terser
```

2. **é…ç½®å·²å®Œæˆ**ï¼ˆvite.config.tså·²æ›´æ–°ï¼‰

3. **æ„å»ºéªŒè¯**
```bash
npm run build
cat dist/assets/index-*.js | head -20
```

4. **éƒ¨ç½²**
```bash
docker-compose down
docker-compose up -d --build
```

## ğŸ“Š å®‰å…¨ç­‰çº§å¯¹æ¯”

| æ–¹æ¡ˆ | æ··æ·†å¼ºåº¦ | æ€§èƒ½å½±å“ | å®æ–½éš¾åº¦ | æ¨èåº¦ |
|------|---------|---------|---------|--------|
| ESBuildå‹ç¼© | â˜…â˜…â˜†â˜†â˜† | æœ€å° | ç®€å• | â˜…â˜…â˜…â˜†â˜† |
| Terseræ··æ·† | â˜…â˜…â˜…â˜…â˜† | å° | ç®€å• | â˜…â˜…â˜…â˜…â˜… |
| Obfuscator | â˜…â˜…â˜…â˜…â˜… | ä¸­ | ä¸­ç­‰ | â˜…â˜…â˜…â˜…â˜† |
| æœåŠ¡ç«¯ç­¾å | â˜…â˜…â˜…â˜…â˜… | æ—  | å¤æ‚ | â˜…â˜…â˜…â˜…â˜… |

## ğŸ¯ æ€»ç»“

**å½“å‰é…ç½®ï¼ˆTerserï¼‰å·²ç»å¯ä»¥æä¾›è‰¯å¥½çš„ä¿æŠ¤ï¼š**
- âœ… å˜é‡åæ··æ·†
- âœ… ç§»é™¤è°ƒè¯•ä»£ç 
- âœ… æ–‡ä»¶åhashåŒ–
- âœ… å…³é—­source map

**é…åˆé˜²çˆ¬å–æœºåˆ¶ï¼Œå½¢æˆå¤šå±‚é˜²æŠ¤ï¼š**
1. **ä¼ è¾“å±‚** - HTTPSåŠ å¯†
2. **ä»£ç å±‚** - å‰ç«¯æ··æ·†
3. **åº”ç”¨å±‚** - ç­¾åéªŒè¯
4. **è¡Œä¸ºå±‚** - é¢‘ç‡é™åˆ¶
5. **è¯†åˆ«å±‚** - åçˆ¬è™«æ£€æµ‹

**è¿™å·²ç»æ˜¯ä¸€ä¸ªç›¸å½“å®Œå–„çš„é˜²æŠ¤ä½“ç³»ï¼** ğŸ›¡ï¸

---

*æœ€åæ›´æ–°: 2024-10-15*

