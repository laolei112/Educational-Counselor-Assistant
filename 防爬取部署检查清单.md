# 防爬取功能部署检查清单

## 📋 部署前检查

### 1. 密钥配置 ⚠️ **最重要**

- [ ] 已生成强随机密钥（至少32字符）
  ```bash
  python3 -c "import secrets; print(secrets.token_urlsafe(32))"
  ```

- [ ] 前端 `.env` 文件已创建并配置密钥
  ```bash
  # frontend/.env
  VITE_API_SECRET=你的密钥
  VITE_API_KEY=web-client-v1
  ```

- [ ] 后端环境变量已配置密钥
  ```yaml
  # docker-compose.yml
  environment:
    - API_SECRET=你的密钥
  ```

- [ ] **前后端密钥完全一致**（这是最常见的错误！）

### 2. HTTPS配置

- [ ] SSL证书已准备
  - [ ] 证书文件: `/etc/nginx/ssl/betterschool.hk_bundle.crt`
  - [ ] 私钥文件: `/etc/nginx/ssl/betterschool.hk.key`

- [ ] Nginx配置已更新
  - [ ] 80端口重定向到443
  - [ ] 443端口SSL配置正确
  - [ ] 证书路径正确

- [ ] Docker端口映射
  ```yaml
  nginx:
    ports:
      - "80:80"
      - "443:443"  # 确保映射了443端口
  ```

### 3. 中间件配置

- [ ] 已启用所有防护中间件
  ```python
  # backend/backend/basic_settings.py
  MIDDLEWARE = [
      # ...
      "backend.middleware.RateLimitMiddleware.RateLimitMiddleware",
      "backend.middleware.AntiCrawlerMiddleware.AntiCrawlerMiddleware",
      "backend.middleware.SignatureMiddleware.SignatureMiddleware",
  ]
  ```

- [ ] CORS配置包含自定义请求头
  ```python
  CORS_ALLOW_HEADERS = (
      # ...
      'x-api-key',
      'x-timestamp',
      'x-nonce',
      'x-signature',
      'x-device-id',
  )
  ```

- [ ] 各中间件开关状态确认
  - [ ] SignatureMiddleware: `ENABLE_SIGNATURE_CHECK = True`
  - [ ] RateLimitMiddleware: `ENABLE_RATE_LIMIT = True`
  - [ ] AntiCrawlerMiddleware: `ENABLE_ANTI_CRAWLER = True`

### 4. 代码文件检查

**前端文件：**
- [ ] `frontend/src/utils/crypto.ts` - 加密工具类
- [ ] `frontend/src/api/request.ts` - 已集成签名机制
- [ ] `frontend/.env` - 环境变量配置

**后端文件：**
- [ ] `backend/utils/crypto_utils.py` - 签名验证和频率限制
- [ ] `backend/backend/middleware/SignatureMiddleware.py` - 签名中间件
- [ ] `backend/backend/middleware/RateLimitMiddleware.py` - 频率限制中间件
- [ ] `backend/backend/middleware/AntiCrawlerMiddleware.py` - 反爬虫中间件
- [ ] `backend/backend/basic_settings.py` - 中间件配置

## 🚀 部署步骤

### 步骤1: 构建前端
```bash
cd frontend
npm install
npm run build
```

### 步骤2: 构建后端
```bash
cd backend
pip install -r requirements.txt
```

### 步骤3: 启动服务
```bash
# 停止旧服务
docker-compose down

# 构建并启动
docker-compose up -d --build

# 等待服务启动（约30秒）
sleep 30
```

### 步骤4: 检查服务状态
```bash
# 检查容器状态
docker-compose ps

# 应该看到所有服务都是 Up 状态
```

## ✅ 功能验证

### 测试1: 浏览器正常访问
```
打开浏览器访问: https://yourdomain.com
预期: 正常显示页面，可以搜索和查看学校信息
```

### 测试2: 未签名请求被拒绝
```bash
curl https://yourdomain.com/api/schools/primary

预期输出:
{"code": 403, "message": "签名验证失败: 缺少必要的签名参数", "success": false}
```

### 测试3: 爬虫被识别
```bash
curl -H "User-Agent: python-requests/2.28.0" https://yourdomain.com/api/schools/primary

预期输出:
{"code": 403, "message": "访问被拒绝", "success": false}
```

### 测试4: 频率限制生效
```bash
# 快速发送多个请求
for i in {1..110}; do curl -s https://yourdomain.com/api/schools/primary; done

预期: 前100个请求正常，后续返回429错误
```

### 测试5: 查看日志
```bash
docker-compose logs backend | tail -50

预期: 能看到各种拦截日志
```

## 📊 监控检查

### 日志监控
```bash
# 实时查看日志
docker-compose logs -f backend

# 查看拦截统计
docker-compose exec backend grep -c "签名验证失败\|频率限制\|爬虫" /app/log/backend.log

# 查看最近的拦截
docker-compose exec backend tail -100 /app/log/backend.log | grep -E "(403|429)"
```

### 性能监控
```bash
# 查看响应时间（应该只增加5-10ms）
curl -w "@curl-format.txt" -o /dev/null -s https://yourdomain.com/api/schools/primary

# curl-format.txt 内容：
# time_namelookup:  %{time_namelookup}\n
# time_connect:  %{time_connect}\n
# time_starttransfer:  %{time_starttransfer}\n
# time_total:  %{time_total}\n
```

## 🐛 故障排查

### 问题检查清单

**如果浏览器访问失败（403）：**
- [ ] 检查前端.env文件是否存在
- [ ] 检查前后端密钥是否一致
- [ ] 检查浏览器控制台是否有JS错误
- [ ] 检查请求头是否包含签名信息（开发者工具 > Network）

**如果SSL证书错误：**
- [ ] 检查证书文件路径是否正确
- [ ] 检查证书文件权限（应该可读）
- [ ] 检查证书是否过期
- [ ] 检查域名是否匹配

**如果性能下降明显：**
- [ ] 检查是否开启了过多的日志
- [ ] 考虑使用Redis存储频率限制数据
- [ ] 检查中间件顺序是否合理

**如果日志没有拦截记录：**
- [ ] 检查中间件是否正确启用
- [ ] 检查日志配置是否正确
- [ ] 检查白名单配置是否过于宽松

## 🔒 安全加固建议

### 生产环境必做
- [ ] 使用强随机密钥（不使用默认密钥）
- [ ] 密钥通过环境变量传递（不硬编码）
- [ ] 强制使用HTTPS（已配置）
- [ ] 定期轮换密钥（建议每季度一次）

### 建议配置
- [ ] 使用Redis存储频率限制数据
- [ ] 配置日志告警（拦截率过高时告警）
- [ ] 定期审查拦截日志
- [ ] 准备IP黑名单功能
- [ ] 准备验证码后备方案

### 监控告警
- [ ] 设置日志监控
- [ ] 统计拦截率
- [ ] 监控异常IP
- [ ] 性能监控（响应时间）

## 📝 部署后任务

### 第一天
- [ ] 监控日志，确认拦截正常工作
- [ ] 检查是否有误拦截（正常用户被拦截）
- [ ] 收集用户反馈

### 第一周
- [ ] 统计拦截数据
- [ ] 优化拦截规则（如果有误拦截）
- [ ] 评估性能影响

### 定期维护
- [ ] 每周查看拦截日志
- [ ] 每月统计拦截数据
- [ ] 每季度轮换密钥
- [ ] 每年审查和更新防护策略

## 🆘 应急响应

### 如果出现大量误拦截
```bash
# 1. 立即禁用相关中间件
docker-compose exec backend vi /app/backend/backend/middleware/SignatureMiddleware.py
# 修改 ENABLE_SIGNATURE_CHECK = False

# 2. 重启服务
docker-compose restart backend

# 3. 分析日志找出原因
docker-compose logs backend | grep "403\|429" > blocked_requests.log

# 4. 修复问题后重新启用
```

### 如果受到DDoS攻击
```bash
# 1. 降低频率限制阈值
# 编辑 backend/utils/crypto_utils.py
# rate_limiter = RateLimiter(max_requests=10, time_window=60)

# 2. 启用更严格的检测
# 编辑 backend/backend/middleware/AntiCrawlerMiddleware.py
# DETECTION_MODE = 'strict'

# 3. 考虑使用CDN或DDoS防护服务
```

## 📞 支持资源

- **完整文档**: `防爬取和加密方案说明.md`
- **快速配置**: `防爬取快速配置指南.md`
- **代码仓库**: 所有相关代码已提交

## ✅ 最终确认

部署完成后，请确认：

- [ ] ✅ 所有测试通过
- [ ] ✅ 日志显示拦截正常工作
- [ ] ✅ 性能影响在可接受范围内（<10ms）
- [ ] ✅ 没有误拦截正常用户
- [ ] ✅ 监控系统已配置
- [ ] ✅ 应急响应流程已准备
- [ ] ✅ 团队成员了解新功能

**恭喜！防爬取功能已成功部署！** 🎉

---

*最后更新: 2024-10-15*

