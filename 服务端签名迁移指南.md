# æœåŠ¡ç«¯ç­¾åè¿ç§»æŒ‡å—

## ğŸ¯ è¿ç§»ç›®æ ‡

å°†ç­¾åç”Ÿæˆä»å‰ç«¯ç§»åˆ°åç«¯ï¼Œ**å½»åº•è§£å†³å¯†é’¥æ˜æ–‡æš´éœ²é—®é¢˜**ã€‚

## âœ… å·²å®Œæˆçš„æ›´æ”¹

### åç«¯æ–°å¢æ–‡ä»¶
- âœ… `backend/backend/api/signature_views.py` - ç­¾åç”ŸæˆAPI
- âœ… `backend/backend/api/__init__.py` - æ·»åŠ äº†è·¯ç”±é…ç½®

### åç«¯ä¿®æ”¹æ–‡ä»¶
- âœ… `backend/backend/middleware/SignatureMiddleware.py` - ç™½åå•æ·»åŠ ç­¾åAPI

### å‰ç«¯ä¿®æ”¹æ–‡ä»¶
- âœ… `frontend/src/utils/crypto.ts` - æ”¹ä¸ºè°ƒç”¨åç«¯API
- âœ… `frontend/src/api/request.ts` - ä¼ é€’methodå‚æ•°
- âœ… `frontend/env.example` - ä¸å†éœ€è¦å¯†é’¥é…ç½®

## ğŸš€ å¿«é€Ÿéƒ¨ç½²ï¼ˆ5åˆ†é’Ÿï¼‰

### æ­¥éª¤1: æ›´æ–°åç«¯é…ç½®ï¼ˆ1åˆ†é’Ÿï¼‰

ç¼–è¾‘ç­¾åAPIå…è®¸çš„æ¥æºï¼š

```bash
# ç¼–è¾‘ backend/backend/api/signature_views.py
vi backend/backend/api/signature_views.py
```

æ‰¾åˆ° `allowed_origins` å¹¶æ·»åŠ ä½ çš„åŸŸåï¼š

```python
allowed_origins = [
    'https://betterschool.hk',      # ä½ çš„ç”Ÿäº§åŸŸå
    'https://www.betterschool.hk',  # å¦‚æœæœ‰www
    'http://localhost:3000',        # å¼€å‘ç¯å¢ƒ
    'http://localhost:5173',        # Viteå¼€å‘æœåŠ¡å™¨
]
```

### æ­¥éª¤2: åˆ é™¤å‰ç«¯å¯†é’¥é…ç½®ï¼ˆå¯é€‰ï¼‰

```bash
# å¦‚æœå­˜åœ¨ .env æ–‡ä»¶ï¼Œå¯ä»¥åˆ é™¤å¯†é’¥é…ç½®
cd frontend
rm -f .env  # æˆ–è€…åˆ é™¤ VITE_API_SECRET ç›¸å…³é…ç½®
```

### æ­¥éª¤3: é‡æ–°æ„å»ºå’Œéƒ¨ç½²ï¼ˆ3åˆ†é’Ÿï¼‰

```bash
# å›åˆ°é¡¹ç›®æ ¹ç›®å½•
cd ..

# åœæ­¢æœåŠ¡
docker-compose down

# é‡æ–°æ„å»º
docker-compose up -d --build

# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 30
```

### æ­¥éª¤4: éªŒè¯éƒ¨ç½²ï¼ˆ1åˆ†é’Ÿï¼‰

#### éªŒè¯1: ç­¾åAPIå¯è®¿é—®
```bash
curl -X POST http://localhost:8080/api/generate-signature \
  -H "Content-Type: application/json" \
  -H "Origin: http://localhost:3000" \
  -d '{"params": {"page": 1}, "method": "GET"}'
```

**é¢„æœŸè¾“å‡ºï¼š**
```json
{
  "code": 200,
  "success": true,
  "data": {
    "timestamp": 1697366400,
    "nonce": "abc123xyz...",
    "apiKey": "web-client-v1",
    "signature": "sha256hash..."
  }
}
```

#### éªŒè¯2: å‰ç«¯åŠŸèƒ½æ­£å¸¸
```bash
# æ‰“å¼€æµè§ˆå™¨
https://betterschool.hk

# æµ‹è¯•åŠŸèƒ½ï¼š
# 1. æœç´¢å­¦æ ¡ âœ“
# 2. æŸ¥çœ‹è¯¦æƒ… âœ“
# 3. ç­›é€‰åŠŸèƒ½ âœ“
```

#### éªŒè¯3: å‰ç«¯ä»£ç æ— å¯†é’¥
```bash
cd frontend
npm run build

# æœç´¢å¯†é’¥ï¼ˆåº”è¯¥æ‰¾ä¸åˆ°ï¼‰
grep -r "secret" dist/assets/*.js
grep -r "API_SECRET" dist/assets/*.js

# è¾“å‡ºåº”è¯¥æ˜¯ç©ºï¼ˆæˆ–è€…åªæœ‰æ— å…³çš„å†…å®¹ï¼‰
```

## ğŸ” è¯¦ç»†éªŒè¯

### 1. æ£€æŸ¥ç­¾åAPIæ—¥å¿—

```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—
docker-compose logs -f backend | grep "ç­¾å"

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
# INFO ç­¾åç”Ÿæˆè¯·æ±‚, IP: xxx.xxx.xxx.xxx, Origin: https://betterschool.hk
```

### 2. æµè§ˆå™¨ç½‘ç»œé¢æ¿

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼š

1. **Networkæ ‡ç­¾**
2. æœç´¢å­¦æ ¡
3. åº”è¯¥çœ‹åˆ°ä¸¤ä¸ªè¯·æ±‚ï¼š
   - `POST /api/generate-signature` ï¼ˆæ–°å¢ï¼‰
   - `GET /api/schools/primary` ï¼ˆåŸæœ‰ï¼‰

### 3. æ£€æŸ¥è¯·æ±‚æµç¨‹

**é¢„æœŸæµç¨‹ï¼š**
```
ç”¨æˆ·æœç´¢
  â†“
POST /api/generate-signature
  â† {"timestamp": ..., "signature": ...}
  â†“
GET /api/schools/primary
  Headers: X-Timestamp, X-Signature
  â† å­¦æ ¡æ•°æ®
```

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### æµ‹è¯•å“åº”æ—¶é—´

```bash
# æµ‹è¯•ç­¾åç”Ÿæˆé€Ÿåº¦
time curl -X POST http://localhost:8080/api/generate-signature \
  -H "Content-Type: application/json" \
  -d '{"params": {"page": 1}, "method": "GET"}' \
  -s > /dev/null

# åº”è¯¥åœ¨ 50-100ms å·¦å³
```

### æµ‹è¯•å®Œæ•´è¯·æ±‚æµç¨‹

```bash
# ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹
# Network â†’ æ‰¾åˆ°å­¦æ ¡åˆ—è¡¨è¯·æ±‚ â†’ Timingæ ‡ç­¾

# æ€»æ—¶é—´åº”è¯¥ < 200msï¼ˆç­¾å50ms + è¯·æ±‚100msï¼‰
```

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ç­¾åç”Ÿæˆè¿”å›403

**é”™è¯¯ä¿¡æ¯ï¼š**
```json
{"code": 403, "message": "è¯·æ±‚æ¥æºéªŒè¯å¤±è´¥"}
```

**åŸå› ï¼š** åŸŸåä¸åœ¨å…è®¸åˆ—è¡¨ä¸­

**è§£å†³ï¼š**
```python
# ç¼–è¾‘ backend/backend/api/signature_views.py
allowed_origins = [
    'https://ä½ çš„åŸŸå.com',  # æ·»åŠ ä½ çš„åŸŸå
    'http://localhost:3000',
]
```

### Q2: CORSé”™è¯¯

**é”™è¯¯ä¿¡æ¯ï¼š**
```
Access to fetch at 'http://localhost:8080/api/generate-signature' 
from origin 'http://localhost:3000' has been blocked by CORS policy
```

**è§£å†³ï¼š**
```python
# ç¼–è¾‘ backend/backend/basic_settings.py
CORS_ORIGIN_WHITELIST = (
    "http://localhost:3000",
    "http://localhost:5173",
    "https://ä½ çš„åŸŸå.com",
)
```

### Q3: å‰ç«¯æŠ¥é”™"æ— æ³•ç”Ÿæˆè¯·æ±‚ç­¾å"

**å¯èƒ½åŸå› ï¼š**
1. åç«¯æœåŠ¡æœªå¯åŠ¨
2. ç­¾åAPIè·¯ç”±é…ç½®é”™è¯¯
3. ç½‘ç»œè¿æ¥é—®é¢˜

**æ’æŸ¥ï¼š**
```bash
# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps

# 2. æ£€æŸ¥æ—¥å¿—
docker-compose logs backend

# 3. æ‰‹åŠ¨æµ‹è¯•API
curl -X POST http://localhost:8080/api/generate-signature \
  -H "Content-Type: application/json" \
  -d '{"method": "GET"}'
```

### Q4: æ€§èƒ½æ˜æ˜¾ä¸‹é™

**å¦‚æœå“åº”æ—¶é—´ > 500msï¼š**

**è§£å†³1: å®ç°ç­¾åç¼“å­˜**
```typescript
// frontend/src/utils/crypto.ts
const signatureCache = new Map()

export async function generateSignature(...) {
  const cacheKey = JSON.stringify({params, body, method})
  const cached = signatureCache.get(cacheKey)
  
  // å¦‚æœç¼“å­˜æœªè¿‡æœŸï¼ˆ30ç§’å†…ï¼‰
  if (cached && Date.now() - cached.time < 30000) {
    return cached.data
  }
  
  // ç”Ÿæˆæ–°ç­¾å
  const data = await fetchSignature(...)
  signatureCache.set(cacheKey, { data, time: Date.now() })
  
  return data
}
```

**è§£å†³2: æ‰¹é‡ç”Ÿæˆç­¾å**
```python
# åç«¯æ”¯æŒæ‰¹é‡ç”Ÿæˆï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰
@csrf_exempt
@require_http_methods(["POST"])
def generate_multiple_signatures(request):
    """æ‰¹é‡ç”Ÿæˆç­¾å"""
    requests = json.loads(request.body)
    results = []
    
    for req in requests:
        signature = generate_one_signature(req)
        results.append(signature)
    
    return JsonResponse({'code': 200, 'data': results})
```

## ğŸ“‹ å›æ»šæ–¹æ¡ˆ

å¦‚æœé‡åˆ°ä¸¥é‡é—®é¢˜éœ€è¦å›æ»šï¼š

### æ–¹æ¡ˆ1: ç¦ç”¨ç­¾åéªŒè¯ï¼ˆä¸´æ—¶ï¼‰

```python
# backend/backend/middleware/SignatureMiddleware.py
ENABLE_SIGNATURE_CHECK = False  # ä¸´æ—¶ç¦ç”¨
```

### æ–¹æ¡ˆ2: æ¢å¤å®¢æˆ·ç«¯ç­¾åï¼ˆä¸æ¨èï¼‰

```bash
# æ¢å¤åˆ°ä¹‹å‰çš„ç‰ˆæœ¬
git log --oneline
git revert <commit-hash>

# é‡æ–°éƒ¨ç½²
docker-compose up -d --build
```

## âœ… è¿ç§»æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰
- [ ] ç¡®è®¤æ‰€æœ‰æ–‡ä»¶å·²æ›´æ–°
- [ ] é…ç½®äº†å…è®¸çš„åŸŸå
- [ ] æµ‹è¯•ç¯å¢ƒéªŒè¯é€šè¿‡

### éƒ¨ç½²ä¸­
- [ ] åœæ­¢æ—§æœåŠ¡
- [ ] æ„å»ºæ–°é•œåƒ
- [ ] å¯åŠ¨æ–°æœåŠ¡
- [ ] ç­‰å¾…æœåŠ¡å°±ç»ª

### éƒ¨ç½²å
- [ ] ç­¾åAPIå¯è®¿é—®ï¼ˆcurlæµ‹è¯•ï¼‰
- [ ] å‰ç«¯åŠŸèƒ½æ­£å¸¸ï¼ˆæµè§ˆå™¨æµ‹è¯•ï¼‰
- [ ] å‰ç«¯ä»£ç æ— å¯†é’¥ï¼ˆgrepæ£€æŸ¥ï¼‰
- [ ] æ—¥å¿—æ­£å¸¸ï¼ˆæ— é”™è¯¯ï¼‰
- [ ] æ€§èƒ½å¯æ¥å—ï¼ˆ<200msï¼‰

## ğŸ‰ è¿ç§»å®Œæˆç¡®è®¤

å®Œæˆä»¥ä¸Šæ‰€æœ‰æ­¥éª¤åï¼Œä½ çš„ç³»ç»Ÿåº”è¯¥ï¼š

âœ… **å®‰å…¨æ€§å¤§å¹…æå‡**
- å‰ç«¯ä»£ç ä¸åŒ…å«ä»»ä½•å¯†é’¥
- å³ä½¿å®Œå…¨é€†å‘ä¹Ÿæ— æ³•ä¼ªé€ ç­¾å
- æ¥æºéªŒè¯é˜²æ­¢å¤–éƒ¨è°ƒç”¨

âœ… **åŠŸèƒ½å®Œå…¨æ­£å¸¸**
- æ‰€æœ‰APIè¯·æ±‚æ­£å¸¸
- ç­¾åéªŒè¯æ­£å¸¸å·¥ä½œ
- ç”¨æˆ·ä½“éªŒæ— å½±å“

âœ… **æ€§èƒ½å¯æ¥å—**
- é¢å¤–å»¶è¿Ÿ < 100ms
- å¯é€šè¿‡ç¼“å­˜è¿›ä¸€æ­¥ä¼˜åŒ–

## ğŸ“ æ”¯æŒå’Œæ–‡æ¡£

- **è¯¦ç»†æ¶æ„è¯´æ˜** â†’ `æœåŠ¡ç«¯ç­¾åæ–¹æ¡ˆè¯´æ˜.md`
- **é˜²çˆ¬å–æ€»è§ˆ** â†’ `é˜²çˆ¬å–å’ŒåŠ å¯†æ–¹æ¡ˆè¯´æ˜.md`
- **éƒ¨ç½²æ£€æŸ¥** â†’ `é˜²çˆ¬å–éƒ¨ç½²æ£€æŸ¥æ¸…å•.md`

---

## ğŸ” å®‰å…¨æå‡æ€»ç»“

### ä¿®æ”¹å‰ï¼ˆå®¢æˆ·ç«¯ç­¾åï¼‰
```javascript
// å‰ç«¯ä»£ç ä¸­
const secret = "your-secret-key"  // âŒ å¯†é’¥æ˜æ–‡æš´éœ²
```
**é£é™©ï¼š** æ”»å‡»è€…å¯ä»¥è·å–å¯†é’¥å¹¶ä¼ªé€ ç­¾å

### ä¿®æ”¹åï¼ˆæœåŠ¡ç«¯ç­¾åï¼‰
```javascript
// å‰ç«¯ä»£ç ä¸­
const signature = await fetch('/api/generate-signature')  // âœ… æ— å¯†é’¥
```
**å®‰å…¨ï¼š** å¯†é’¥å®Œå…¨åœ¨åç«¯ï¼Œæ”»å‡»è€…æ— æ³•è·å–

---

**è¿™æ˜¯ä¸šç•Œæœ€å®‰å…¨çš„å‰ç«¯APIç­¾åæ–¹æ¡ˆï¼** ğŸ›¡ï¸ğŸ‰

*æœ€åæ›´æ–°: 2024-10-15*

