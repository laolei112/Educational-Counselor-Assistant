# 防爬取功能快速配置指南

## 🚀 5分钟快速启用

### 步骤1：生成密钥（30秒）

```bash
# 生成一个强随机密钥
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
# 输出示例: xK7mP9vQw2R5tY8uN3jL6sF4hG1dA0zC
```

**保存这个密钥**，后续配置会用到！

### 步骤2：配置前端（1分钟）

创建 `frontend/.env` 文件：

```bash
cd frontend
cat > .env << 'EOF'
VITE_API_SECRET=xK7mP9vQw2R5tY8uN3jL6sF4hG1dA0zC
VITE_API_KEY=web-client-v1
EOF
```

**注意**：将上面的密钥替换为步骤1生成的密钥！

### 步骤3：配置后端（1分钟）

#### 方式A：使用环境变量（推荐）

编辑 `docker-compose.yml`：

```yaml
services:
  backend:
    environment:
      - API_SECRET=xK7mP9vQw2R5tY8uN3jL6sF4hG1dA0zC
      - EDU_ENV=DEV
```

#### 方式B：直接修改代码（不推荐）

编辑 `backend/utils/crypto_utils.py`：

```python
def __init__(self, secret_key: str = None, valid_api_keys: list = None):
    self.secret_key = secret_key or os.environ.get('API_SECRET', 'xK7mP9vQw2R5tY8uN3jL6sF4hG1dA0zC')
    self.valid_api_keys = valid_api_keys or ['web-client-v1']
```

### 步骤4：重启服务（2分钟）

```bash
# 停止服务
docker-compose down

# 重新构建并启动
docker-compose up -d --build

# 查看日志确认启动成功
docker-compose logs -f backend | head -50
```

### 步骤5：验证功能（1分钟）

#### 测试1：浏览器访问应该正常
```bash
# 打开浏览器访问
https://yourdomain.com
```

#### 测试2：curl应该被拒绝
```bash
# 这个请求应该返回403
curl https://yourdomain.com/api/schools/primary

# 输出示例：
# {"code": 403, "message": "签名验证失败: 缺少必要的签名参数", "success": false}
```

✅ 如果看到403错误，说明防护已生效！

## 📊 验证检查清单

- [ ] 前端 `.env` 文件已创建，密钥已设置
- [ ] 后端环境变量已配置（或代码已修改）
- [ ] **前后端密钥必须完全一致**
- [ ] 服务已重启
- [ ] 浏览器访问正常
- [ ] curl请求被拒绝（403）

## 🔧 开发环境临时禁用

如果开发时需要临时禁用防护：

### 方式1：禁用签名验证（推荐）

编辑 `backend/backend/middleware/SignatureMiddleware.py`：
```python
ENABLE_SIGNATURE_CHECK = False  # 改为False
```

### 方式2：禁用所有中间件

编辑 `backend/backend/basic_settings.py`，注释掉防护中间件：
```python
MIDDLEWARE = [
    # ... 其他中间件 ...
    # "backend.middleware.RateLimitMiddleware.RateLimitMiddleware",
    # "backend.middleware.AntiCrawlerMiddleware.AntiCrawlerMiddleware",
    # "backend.middleware.SignatureMiddleware.SignatureMiddleware",
]
```

**注意**：禁用后记得重启服务！

## ⚙️ 自定义配置

### 调整频率限制

编辑 `backend/utils/crypto_utils.py`：

```python
# 修改这一行，调整限制参数
rate_limiter = RateLimiter(
    max_requests=100,  # 改为200可增加限额
    time_window=60     # 时间窗口（秒）
)
```

### 调整反爬虫严格程度

编辑 `backend/backend/middleware/AntiCrawlerMiddleware.py`：

```python
# moderate（适中）或 strict（严格）
DETECTION_MODE = 'moderate'  # 推荐使用适中模式
```

### 添加白名单路径

如果某些API不需要保护，添加到白名单：

编辑各中间件文件的 `WHITELIST_PATHS`：
```python
WHITELIST_PATHS = [
    '/api/health',
    '/nginx-health',
    '/api/public/',     # 添加公开路径
]
```

## 🐛 常见问题

### Q1: 前端请求全部失败（403）

**A:** 检查前后端密钥是否一致
```bash
# 前端密钥
cat frontend/.env | grep VITE_API_SECRET

# 后端密钥（如果使用环境变量）
docker-compose exec backend env | grep API_SECRET
```

### Q2: 开发时频繁触发频率限制

**A:** 临时禁用或增加限额
```python
# backend/utils/crypto_utils.py
rate_limiter = RateLimiter(max_requests=1000, time_window=60)
```

### Q3: 时间戳验证失败

**A:** 同步服务器时间
```bash
# 在服务器上执行
ntpdate -u pool.ntp.org
```

### Q4: 跨域问题（CORS错误）

**A:** 检查CORS配置是否包含自定义请求头

编辑 `backend/backend/basic_settings.py`，确保包含：
```python
CORS_ALLOW_HEADERS = (
    # ... 其他头 ...
    'x-api-key',
    'x-timestamp',
    'x-nonce',
    'x-signature',
    'x-device-id',
)
```

## 📱 生产环境部署

### 额外的安全措施

1. **强制HTTPS**（已配置在nginx）
2. **使用强密钥**（至少32字符随机）
3. **环境变量管理密钥**（不要硬编码）
4. **启用日志监控**
5. **定期审查拦截日志**

### 监控命令

```bash
# 查看实时日志
docker-compose logs -f backend

# 统计被拦截的请求
docker-compose exec backend grep -c "签名验证失败\|频率限制\|爬虫" /app/log/backend.log

# 查看最近的拦截记录
docker-compose exec backend tail -100 /app/log/backend.log | grep -E "(403|429)"
```

## 📞 获取帮助

- 完整文档：查看 `防爬取和加密方案说明.md`
- 架构说明：文档中有详细的架构图和流程说明
- 故障排查：文档包含完整的故障排查指南

---

## ✅ 配置完成检查

完成以上步骤后，你的系统应该具备以下防护能力：

- ✅ 请求签名验证（防止未授权访问）
- ✅ 时间戳验证（防止重放攻击）
- ✅ 频率限制（防止爆破和DDoS）
- ✅ 反爬虫检测（识别常见爬虫工具）
- ✅ HTTPS加密（传输层安全）

**恭喜！你的系统现在已经具备多层次的数据保护！** 🎉

