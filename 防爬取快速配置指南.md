# é˜²çˆ¬å–åŠŸèƒ½å¿«é€Ÿé…ç½®æŒ‡å—

## ðŸš€ 5åˆ†é’Ÿå¿«é€Ÿå¯ç”¨

### æ­¥éª¤1ï¼šç”Ÿæˆå¯†é’¥ï¼ˆ30ç§’ï¼‰

```bash
# ç”Ÿæˆä¸€ä¸ªå¼ºéšæœºå¯†é’¥
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
# è¾“å‡ºç¤ºä¾‹: xK7mP9vQw2R5tY8uN3jL6sF4hG1dA0zC
```

**ä¿å­˜è¿™ä¸ªå¯†é’¥**ï¼ŒåŽç»­é…ç½®ä¼šç”¨åˆ°ï¼

### æ­¥éª¤2ï¼šé…ç½®å‰ç«¯ï¼ˆ1åˆ†é’Ÿï¼‰

åˆ›å»º `frontend/.env` æ–‡ä»¶ï¼š

```bash
cd frontend
cat > .env << 'EOF'
VITE_API_SECRET=xK7mP9vQw2R5tY8uN3jL6sF4hG1dA0zC
VITE_API_KEY=web-client-v1
EOF
```

**æ³¨æ„**ï¼šå°†ä¸Šé¢çš„å¯†é’¥æ›¿æ¢ä¸ºæ­¥éª¤1ç”Ÿæˆçš„å¯†é’¥ï¼

### æ­¥éª¤3ï¼šé…ç½®åŽç«¯ï¼ˆ1åˆ†é’Ÿï¼‰

#### æ–¹å¼Aï¼šä½¿ç”¨çŽ¯å¢ƒå˜é‡ï¼ˆæŽ¨èï¼‰

ç¼–è¾‘ `docker-compose.yml`ï¼š

```yaml
services:
  backend:
    environment:
      - API_SECRET=xK7mP9vQw2R5tY8uN3jL6sF4hG1dA0zC
      - EDU_ENV=DEV
```

#### æ–¹å¼Bï¼šç›´æŽ¥ä¿®æ”¹ä»£ç ï¼ˆä¸æŽ¨èï¼‰

ç¼–è¾‘ `backend/utils/crypto_utils.py`ï¼š

```python
def __init__(self, secret_key: str = None, valid_api_keys: list = None):
    self.secret_key = secret_key or os.environ.get('API_SECRET', 'xK7mP9vQw2R5tY8uN3jL6sF4hG1dA0zC')
    self.valid_api_keys = valid_api_keys or ['web-client-v1']
```

### æ­¥éª¤4ï¼šé‡å¯æœåŠ¡ï¼ˆ2åˆ†é’Ÿï¼‰

```bash
# åœæ­¢æœåŠ¡
docker-compose down

# é‡æ–°æž„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build

# æŸ¥çœ‹æ—¥å¿—ç¡®è®¤å¯åŠ¨æˆåŠŸ
docker-compose logs -f backend | head -50
```

### æ­¥éª¤5ï¼šéªŒè¯åŠŸèƒ½ï¼ˆ1åˆ†é’Ÿï¼‰

#### æµ‹è¯•1ï¼šæµè§ˆå™¨è®¿é—®åº”è¯¥æ­£å¸¸
```bash
# æ‰“å¼€æµè§ˆå™¨è®¿é—®
https://yourdomain.com
```

#### æµ‹è¯•2ï¼šcurlåº”è¯¥è¢«æ‹’ç»
```bash
# è¿™ä¸ªè¯·æ±‚åº”è¯¥è¿”å›ž403
curl https://yourdomain.com/api/schools/primary

# è¾“å‡ºç¤ºä¾‹ï¼š
# {"code": 403, "message": "ç­¾åéªŒè¯å¤±è´¥: ç¼ºå°‘å¿…è¦çš„ç­¾åå‚æ•°", "success": false}
```

âœ… å¦‚æžœçœ‹åˆ°403é”™è¯¯ï¼Œè¯´æ˜Žé˜²æŠ¤å·²ç”Ÿæ•ˆï¼

## ðŸ“Š éªŒè¯æ£€æŸ¥æ¸…å•

- [ ] å‰ç«¯ `.env` æ–‡ä»¶å·²åˆ›å»ºï¼Œå¯†é’¥å·²è®¾ç½®
- [ ] åŽç«¯çŽ¯å¢ƒå˜é‡å·²é…ç½®ï¼ˆæˆ–ä»£ç å·²ä¿®æ”¹ï¼‰
- [ ] **å‰åŽç«¯å¯†é’¥å¿…é¡»å®Œå…¨ä¸€è‡´**
- [ ] æœåŠ¡å·²é‡å¯
- [ ] æµè§ˆå™¨è®¿é—®æ­£å¸¸
- [ ] curlè¯·æ±‚è¢«æ‹’ç»ï¼ˆ403ï¼‰

## ðŸ”§ å¼€å‘çŽ¯å¢ƒä¸´æ—¶ç¦ç”¨

å¦‚æžœå¼€å‘æ—¶éœ€è¦ä¸´æ—¶ç¦ç”¨é˜²æŠ¤ï¼š

### æ–¹å¼1ï¼šç¦ç”¨ç­¾åéªŒè¯ï¼ˆæŽ¨èï¼‰

ç¼–è¾‘ `backend/backend/middleware/SignatureMiddleware.py`ï¼š
```python
ENABLE_SIGNATURE_CHECK = False  # æ”¹ä¸ºFalse
```

### æ–¹å¼2ï¼šç¦ç”¨æ‰€æœ‰ä¸­é—´ä»¶

ç¼–è¾‘ `backend/backend/basic_settings.py`ï¼Œæ³¨é‡ŠæŽ‰é˜²æŠ¤ä¸­é—´ä»¶ï¼š
```python
MIDDLEWARE = [
    # ... å…¶ä»–ä¸­é—´ä»¶ ...
    # "backend.middleware.RateLimitMiddleware.RateLimitMiddleware",
    # "backend.middleware.AntiCrawlerMiddleware.AntiCrawlerMiddleware",
    # "backend.middleware.SignatureMiddleware.SignatureMiddleware",
]
```

**æ³¨æ„**ï¼šç¦ç”¨åŽè®°å¾—é‡å¯æœåŠ¡ï¼

## âš™ï¸ è‡ªå®šä¹‰é…ç½®

### è°ƒæ•´é¢‘çŽ‡é™åˆ¶

ç¼–è¾‘ `backend/utils/crypto_utils.py`ï¼š

```python
# ä¿®æ”¹è¿™ä¸€è¡Œï¼Œè°ƒæ•´é™åˆ¶å‚æ•°
rate_limiter = RateLimiter(
    max_requests=100,  # æ”¹ä¸º200å¯å¢žåŠ é™é¢
    time_window=60     # æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
)
```

### è°ƒæ•´åçˆ¬è™«ä¸¥æ ¼ç¨‹åº¦

ç¼–è¾‘ `backend/backend/middleware/AntiCrawlerMiddleware.py`ï¼š

```python
# moderateï¼ˆé€‚ä¸­ï¼‰æˆ– strictï¼ˆä¸¥æ ¼ï¼‰
DETECTION_MODE = 'moderate'  # æŽ¨èä½¿ç”¨é€‚ä¸­æ¨¡å¼
```

### æ·»åŠ ç™½åå•è·¯å¾„

å¦‚æžœæŸäº›APIä¸éœ€è¦ä¿æŠ¤ï¼Œæ·»åŠ åˆ°ç™½åå•ï¼š

ç¼–è¾‘å„ä¸­é—´ä»¶æ–‡ä»¶çš„ `WHITELIST_PATHS`ï¼š
```python
WHITELIST_PATHS = [
    '/api/health',
    '/nginx-health',
    '/api/public/',     # æ·»åŠ å…¬å¼€è·¯å¾„
]
```

## ðŸ› å¸¸è§é—®é¢˜

### Q1: å‰ç«¯è¯·æ±‚å…¨éƒ¨å¤±è´¥ï¼ˆ403ï¼‰

**A:** æ£€æŸ¥å‰åŽç«¯å¯†é’¥æ˜¯å¦ä¸€è‡´
```bash
# å‰ç«¯å¯†é’¥
cat frontend/.env | grep VITE_API_SECRET

# åŽç«¯å¯†é’¥ï¼ˆå¦‚æžœä½¿ç”¨çŽ¯å¢ƒå˜é‡ï¼‰
docker-compose exec backend env | grep API_SECRET
```

### Q2: å¼€å‘æ—¶é¢‘ç¹è§¦å‘é¢‘çŽ‡é™åˆ¶

**A:** ä¸´æ—¶ç¦ç”¨æˆ–å¢žåŠ é™é¢
```python
# backend/utils/crypto_utils.py
rate_limiter = RateLimiter(max_requests=1000, time_window=60)
```

### Q3: æ—¶é—´æˆ³éªŒè¯å¤±è´¥

**A:** åŒæ­¥æœåŠ¡å™¨æ—¶é—´
```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
ntpdate -u pool.ntp.org
```

### Q4: è·¨åŸŸé—®é¢˜ï¼ˆCORSé”™è¯¯ï¼‰

**A:** æ£€æŸ¥CORSé…ç½®æ˜¯å¦åŒ…å«è‡ªå®šä¹‰è¯·æ±‚å¤´

ç¼–è¾‘ `backend/backend/basic_settings.py`ï¼Œç¡®ä¿åŒ…å«ï¼š
```python
CORS_ALLOW_HEADERS = (
    # ... å…¶ä»–å¤´ ...
    'x-api-key',
    'x-timestamp',
    'x-nonce',
    'x-signature',
    'x-device-id',
)
```

## ðŸ“± ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²

### é¢å¤–çš„å®‰å…¨æŽªæ–½

1. **å¼ºåˆ¶HTTPS**ï¼ˆå·²é…ç½®åœ¨nginxï¼‰
2. **ä½¿ç”¨å¼ºå¯†é’¥**ï¼ˆè‡³å°‘32å­—ç¬¦éšæœºï¼‰
3. **çŽ¯å¢ƒå˜é‡ç®¡ç†å¯†é’¥**ï¼ˆä¸è¦ç¡¬ç¼–ç ï¼‰
4. **å¯ç”¨æ—¥å¿—ç›‘æŽ§**
5. **å®šæœŸå®¡æŸ¥æ‹¦æˆªæ—¥å¿—**

### ç›‘æŽ§å‘½ä»¤

```bash
# æŸ¥çœ‹å®žæ—¶æ—¥å¿—
docker-compose logs -f backend

# ç»Ÿè®¡è¢«æ‹¦æˆªçš„è¯·æ±‚
docker-compose exec backend grep -c "ç­¾åéªŒè¯å¤±è´¥\|é¢‘çŽ‡é™åˆ¶\|çˆ¬è™«" /app/log/backend.log

# æŸ¥çœ‹æœ€è¿‘çš„æ‹¦æˆªè®°å½•
docker-compose exec backend tail -100 /app/log/backend.log | grep -E "(403|429)"
```

## ðŸ“ž èŽ·å–å¸®åŠ©

- å®Œæ•´æ–‡æ¡£ï¼šæŸ¥çœ‹ `é˜²çˆ¬å–å’ŒåŠ å¯†æ–¹æ¡ˆè¯´æ˜Ž.md`
- æž¶æž„è¯´æ˜Žï¼šæ–‡æ¡£ä¸­æœ‰è¯¦ç»†çš„æž¶æž„å›¾å’Œæµç¨‹è¯´æ˜Ž
- æ•…éšœæŽ’æŸ¥ï¼šæ–‡æ¡£åŒ…å«å®Œæ•´çš„æ•…éšœæŽ’æŸ¥æŒ‡å—

---

## âœ… é…ç½®å®Œæˆæ£€æŸ¥

å®Œæˆä»¥ä¸Šæ­¥éª¤åŽï¼Œä½ çš„ç³»ç»Ÿåº”è¯¥å…·å¤‡ä»¥ä¸‹é˜²æŠ¤èƒ½åŠ›ï¼š

- âœ… è¯·æ±‚ç­¾åéªŒè¯ï¼ˆé˜²æ­¢æœªæŽˆæƒè®¿é—®ï¼‰
- âœ… æ—¶é—´æˆ³éªŒè¯ï¼ˆé˜²æ­¢é‡æ”¾æ”»å‡»ï¼‰
- âœ… é¢‘çŽ‡é™åˆ¶ï¼ˆé˜²æ­¢çˆ†ç ´å’ŒDDoSï¼‰
- âœ… åçˆ¬è™«æ£€æµ‹ï¼ˆè¯†åˆ«å¸¸è§çˆ¬è™«å·¥å…·ï¼‰
- âœ… HTTPSåŠ å¯†ï¼ˆä¼ è¾“å±‚å®‰å…¨ï¼‰

**æ­å–œï¼ä½ çš„ç³»ç»ŸçŽ°åœ¨å·²ç»å…·å¤‡å¤šå±‚æ¬¡çš„æ•°æ®ä¿æŠ¤ï¼** ðŸŽ‰

