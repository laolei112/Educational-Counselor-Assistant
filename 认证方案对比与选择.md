# è®¤è¯æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©æŒ‡å—

## ğŸ¯ æ–¹æ¡ˆæ€»è§ˆ

| æ–¹æ¡ˆ | æ€§èƒ½ | å®‰å…¨æ€§ | å¤æ‚åº¦ | æ¨èåº¦ |
|------|------|--------|--------|--------|
| 1. JWT Token | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â˜†â˜† | â­â­â­â­â­ |
| 2. æ¯æ¬¡ç­¾åï¼ˆå½“å‰ï¼‰ | â­â­â˜†â˜†â˜† | â­â­â­â­â­ | â­â­â­â­â˜† | â­â­â˜†â˜†â˜† |
| 3. ç­¾åç¼“å­˜ | â­â­â­â­â˜† | â­â­â­â­â˜† | â­â­â­â˜†â˜† | â­â­â­â­â˜† |
| 4. Session Cookie | â­â­â­â­â­ | â­â­â­â­â˜† | â­â­â˜†â˜†â˜† | â­â­â­â˜†â˜† |
| 5. API Key | â­â­â­â­â­ | â­â­â­â˜†â˜† | â­â˜†â˜†â˜†â˜† | â­â­â˜†â˜†â˜† |

## æ–¹æ¡ˆ1ï¼šJWT Token â­â­â­â­â­ **æ¨è**

### ä¼˜åŠ¿
- âœ… **è¡Œä¸šæ ‡å‡†** - OAuth 2.0, JWTå¹¿æ³›ä½¿ç”¨
- âœ… **æ€§èƒ½ä¼˜å¼‚** - åç»­è¯·æ±‚æ— é¢å¤–å¼€é”€
- âœ… **æ— çŠ¶æ€** - æœåŠ¡ç«¯ä¸éœ€è¦å­˜å‚¨Session
- âœ… **å¯æ‰©å±•** - å¯æºå¸¦ç”¨æˆ·ä¿¡æ¯ã€æƒé™ç­‰
- âœ… **è·¨åŸŸå‹å¥½** - é€‚åˆå¾®æœåŠ¡æ¶æ„

### é€‚ç”¨åœºæ™¯
- âœ… ç§»åŠ¨APP
- âœ… å•é¡µåº”ç”¨ï¼ˆSPAï¼‰
- âœ… å¾®æœåŠ¡æ¶æ„
- âœ… éœ€è¦æ°´å¹³æ‰©å±•çš„ç³»ç»Ÿ

### å®ç°
è¯¦è§ `ä¼˜åŒ–æ–¹æ¡ˆ-JWT-Tokenæœºåˆ¶.md`

---

## æ–¹æ¡ˆ2ï¼šæ¯æ¬¡è¯·æ±‚ç­¾åï¼ˆå½“å‰æ–¹æ¡ˆï¼‰

### æµç¨‹
```
æ¯ä¸ªè¯·æ±‚ï¼š
1. POST /api/generate-signature (50ms)
2. GET /api/schools/primary (100ms)
æ€»è®¡ï¼š150ms
```

### ä¼˜åŠ¿
- âœ… å¯†é’¥å®Œå…¨åœ¨æœåŠ¡ç«¯ï¼ˆæœ€å®‰å…¨ï¼‰
- âœ… æ¯æ¬¡è¯·æ±‚ç‹¬ç«‹ç­¾åï¼ˆé˜²é‡æ”¾ï¼‰
- âœ… ä¸éœ€è¦Tokenç®¡ç†

### åŠ£åŠ¿
- âŒ æ€§èƒ½å·®ï¼ˆè¯·æ±‚æ•°ç¿»å€ï¼‰
- âŒ å»¶è¿Ÿé«˜ï¼ˆ+50msæ¯æ¬¡ï¼‰
- âŒ æœåŠ¡å™¨è´Ÿè½½å¤§
- âŒ ç½‘ç»œå¼€é”€å¤§

### é€‚ç”¨åœºæ™¯
- âŒ æé«˜å®‰å…¨è¦æ±‚ï¼ˆé‡‘èæ”¯ä»˜ï¼‰
- âŒ è¯·æ±‚é¢‘ç‡å¾ˆä½çš„åœºæ™¯
- âŒ **ä¸æ¨èç”¨äºå¸¸è§„Webåº”ç”¨**

---

## æ–¹æ¡ˆ3ï¼šç­¾åç¼“å­˜ â­â­â­â­â˜† **å¿«é€Ÿä¼˜åŒ–**

åœ¨å½“å‰æ–¹æ¡ˆåŸºç¡€ä¸Šæ·»åŠ ç¼“å­˜ï¼ŒæŠ˜ä¸­æ–¹æ¡ˆã€‚

### å®ç°

```typescript
// frontend/src/utils/signature-cache.ts

interface CachedSignature {
  timestamp: number
  nonce: string
  apiKey: string
  signature: string
  expiry: number  // è¿‡æœŸæ—¶é—´
}

class SignatureCache {
  private cache = new Map<string, CachedSignature>()
  private readonly CACHE_TTL = 30000  // 30ç§’
  
  /**
   * ç”Ÿæˆç¼“å­˜é”®
   */
  private getCacheKey(params: Record<string, any>, body?: any, method?: string): string {
    return JSON.stringify({ params, body, method })
  }
  
  /**
   * è·å–ç¼“å­˜çš„ç­¾åï¼ˆå¦‚æœæœ‰æ•ˆï¼‰
   */
  get(params: Record<string, any>, body?: any, method?: string): CachedSignature | null {
    const key = this.getCacheKey(params, body, method)
    const cached = this.cache.get(key)
    
    if (!cached) return null
    
    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    if (Date.now() > cached.expiry) {
      this.cache.delete(key)
      return null
    }
    
    return cached
  }
  
  /**
   * ç¼“å­˜ç­¾å
   */
  set(params: Record<string, any>, signature: CachedSignature, body?: any, method?: string) {
    const key = this.getCacheKey(params, body, method)
    this.cache.set(key, {
      ...signature,
      expiry: Date.now() + this.CACHE_TTL
    })
    
    // å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
    this.cleanup()
  }
  
  /**
   * æ¸…ç†è¿‡æœŸç¼“å­˜
   */
  private cleanup() {
    const now = Date.now()
    for (const [key, value] of this.cache.entries()) {
      if (now > value.expiry) {
        this.cache.delete(key)
      }
    }
  }
  
  /**
   * æ¸…ç©ºç¼“å­˜
   */
  clear() {
    this.cache.clear()
  }
}

export const signatureCache = new SignatureCache()
```

```typescript
// frontend/src/utils/crypto.ts - æ›´æ–°generateSignature

export async function generateSignature(
  params: Record<string, any> = {},
  body?: any,
  method: string = 'GET'
): Promise<SignatureData> {
  // 1. æ£€æŸ¥ç¼“å­˜
  const cached = signatureCache.get(params, body, method)
  if (cached) {
    console.log('ä½¿ç”¨ç¼“å­˜çš„ç­¾å')
    return cached
  }
  
  // 2. è¯·æ±‚æ–°ç­¾å
  const signature = await fetchSignatureFromServer(params, body, method)
  
  // 3. ç¼“å­˜ç­¾å
  signatureCache.set(params, signature, body, method)
  
  return signature
}
```

### æ€§èƒ½æå‡

| åœºæ™¯ | æ— ç¼“å­˜ | æœ‰ç¼“å­˜ | æå‡ |
|------|--------|--------|------|
| é¦–æ¬¡è¯·æ±‚ | 150ms | 150ms | 0% |
| é‡å¤è¯·æ±‚ï¼ˆ30så†…ï¼‰ | 150ms | 100ms | **33%â†“** |
| ç›¸åŒå‚æ•°è¯·æ±‚ | 150ms | 100ms | **33%â†“** |

### é€‚ç”¨åœºæ™¯
- âœ… å¿«é€Ÿä¼˜åŒ–å½“å‰æ–¹æ¡ˆ
- âœ… ç”¨æˆ·é¢‘ç¹æŸ¥è¯¢ç›¸åŒæ•°æ®
- âœ… å‚æ•°é‡å¤ç‡é«˜çš„åœºæ™¯

### é™åˆ¶
- âš ï¸ ç¼“å­˜æ—¶é—´ä¸èƒ½å¤ªé•¿ï¼ˆå®‰å…¨æ€§ï¼‰
- âš ï¸ ä¸åŒå‚æ•°ä»éœ€è¦æ–°ç­¾å
- âš ï¸ æ€§èƒ½æå‡æœ‰é™

---

## æ–¹æ¡ˆ4ï¼šSession + Cookie

ä¼ ç»ŸWebåº”ç”¨æ–¹æ¡ˆï¼ŒæœåŠ¡ç«¯å­˜å‚¨Sessionã€‚

### å®ç°

```python
# backend - Djangoè‡ªå¸¦Sessionæ”¯æŒ

from django.contrib.sessions.models import Session

def login(request):
    """ç™»å½•è·å–Session"""
    # éªŒè¯å®¢æˆ·ç«¯
    if verify_client(request):
        request.session['authenticated'] = True
        request.session['client_id'] = get_client_id(request)
        return JsonResponse({'success': True})
    return JsonResponse({'success': False}, status=403)

class SessionAuthMiddleware:
    def __call__(self, request):
        # æ£€æŸ¥Session
        if not request.session.get('authenticated'):
            return JsonResponse({'error': 'Unauthorized'}, status=401)
        
        return self.get_response(request)
```

```typescript
// frontend - è‡ªåŠ¨æºå¸¦Cookie
fetch('/api/schools/primary', {
  credentials: 'include'  // è‡ªåŠ¨å‘é€Cookie
})
```

### ä¼˜åŠ¿
- âœ… å®ç°ç®€å•ï¼ˆDjangoå†…ç½®ï¼‰
- âœ… æ€§èƒ½å¥½ï¼ˆCookieè‡ªåŠ¨å‘é€ï¼‰
- âœ… æœåŠ¡ç«¯å¯æ§ï¼ˆå¯éšæ—¶æ’¤é”€ï¼‰

### åŠ£åŠ¿
- âŒ éœ€è¦æœåŠ¡ç«¯å­˜å‚¨Session
- âŒ è·¨åŸŸéœ€è¦ç‰¹æ®Šé…ç½®
- âŒ ä¸é€‚åˆå¾®æœåŠ¡æ¶æ„
- âŒ CSRFé£é™©

### é€‚ç”¨åœºæ™¯
- âœ… ä¼ ç»ŸWebåº”ç”¨
- âœ… å•ä½“æ¶æ„
- âœ… ä¸éœ€è¦è·¨åŸŸçš„åº”ç”¨

---

## æ–¹æ¡ˆ5ï¼šå›ºå®šAPI Key

æœ€ç®€å•ä½†å®‰å…¨æ€§è¾ƒä½ã€‚

### å®ç°

```typescript
// frontend
const API_KEY = 'your-api-key'

fetch('/api/schools/primary', {
  headers: {
    'X-API-Key': API_KEY
  }
})
```

```python
# backend
class ApiKeyMiddleware:
    VALID_API_KEYS = ['your-api-key']
    
    def __call__(self, request):
        api_key = request.META.get('HTTP_X_API_KEY')
        if api_key not in self.VALID_API_KEYS:
            return JsonResponse({'error': 'Invalid API Key'}, status=403)
        return self.get_response(request)
```

### ä¼˜åŠ¿
- âœ… æç®€å®ç°
- âœ… æ€§èƒ½æœ€å¥½

### åŠ£åŠ¿
- âŒ API Keyä¼šæš´éœ²åœ¨å‰ç«¯
- âŒ æ— æ³•é˜²æ­¢æ³„éœ²åçš„æ»¥ç”¨
- âŒ å®‰å…¨æ€§æœ€ä½

### é€‚ç”¨åœºæ™¯
- âŒ ä»…é€‚ç”¨äºå…¬å¼€æ•°æ®
- âŒ ä¸æ¨èç”¨äºä»»ä½•éœ€è¦ä¿æŠ¤çš„åœºæ™¯

---

## ğŸ¯ æ¨èæ–¹æ¡ˆé€‰æ‹©

### æœ€ä½³å®è·µï¼šJWT Token â­â­â­â­â­

**æ¨èç»™ï¼š**
- ç°ä»£Webåº”ç”¨ï¼ˆSPAï¼‰
- ç§»åŠ¨APP
- éœ€è¦è‰¯å¥½æ€§èƒ½çš„ç³»ç»Ÿ
- **ä½ çš„é¡¹ç›®ï¼ˆé¦™æ¸¯å‡å­¦åŠ©æ‰‹ï¼‰**

**ç†ç”±ï¼š**
1. æ€§èƒ½ä¼˜å¼‚ï¼ˆåç»­è¯·æ±‚å¿«50%ï¼‰
2. è¡Œä¸šæ ‡å‡†ï¼ˆOAuth 2.0ï¼‰
3. æ˜“äºæ‰©å±•
4. å®‰å…¨æ€§é«˜

### å¿«é€Ÿæ”¹è¿›ï¼šç­¾åç¼“å­˜ â­â­â­â­â˜†

**æ¨èç»™ï¼š**
- ä¸æƒ³å¤§æ”¹ä»£ç 
- å¿«é€Ÿä¼˜åŒ–æ€§èƒ½
- è¿‡æ¸¡æ–¹æ¡ˆ

**ç†ç”±ï¼š**
1. æ”¹åŠ¨æœ€å°
2. ç«‹å³è§æ•ˆ
3. å¯é€æ­¥è¿ç§»åˆ°Token

### ä¼ ç»Ÿæ–¹æ¡ˆï¼šSession Cookie â­â­â­â˜†â˜†

**æ¨èç»™ï¼š**
- ä¼ ç»ŸWebåº”ç”¨
- ä¸éœ€è¦è·¨åŸŸ
- å•ä½“æ¶æ„

**ä¸æ¨èç»™ä½ çš„é¡¹ç›®**ï¼ˆå› ä¸ºæ˜¯SPAï¼‰

---

## ğŸ“Š è¯¦ç»†æ€§èƒ½å¯¹æ¯”

### æµ‹è¯•åœºæ™¯ï¼šç”¨æˆ·æœç´¢10æ¬¡å­¦æ ¡

| æ–¹æ¡ˆ | æ€»è¯·æ±‚æ•° | æ€»å»¶è¿Ÿ | æœåŠ¡å™¨è´Ÿè½½ |
|------|---------|--------|-----------|
| æ¯æ¬¡ç­¾å | 20æ¬¡ | 1500ms | 20x |
| ç­¾åç¼“å­˜ | 15æ¬¡ | 1200ms | 15x |
| JWT Token | 11æ¬¡ | 1050ms | 11x |
| Session | 10æ¬¡ | 1000ms | 10x |

**ç»“è®ºï¼šJWT TokenèŠ‚çœ45%è¯·æ±‚ï¼Œé™ä½33%å»¶è¿Ÿï¼**

---

## ğŸš€ è¿ç§»å»ºè®®

### ç«‹å³å®æ–½ï¼ˆ0æˆæœ¬ï¼‰

æ·»åŠ ç­¾åç¼“å­˜ï¼š
```bash
# åªéœ€è¦ä¿®æ”¹frontend/src/utils/crypto.ts
# æ·»åŠ ç¼“å­˜é€»è¾‘ï¼Œ30åˆ†é’Ÿå®Œæˆ
```

### çŸ­æœŸå®æ–½ï¼ˆæ¨èï¼‰

è¿ç§»åˆ°JWT Tokenï¼š
```bash
# 1-2å¤©å®Œæˆ
# å‚è€ƒï¼šä¼˜åŒ–æ–¹æ¡ˆ-JWT-Tokenæœºåˆ¶.md
```

### è¿ç§»è·¯å¾„

```
å½“å‰æ–¹æ¡ˆï¼ˆæ¯æ¬¡ç­¾åï¼‰
    â†“ 30åˆ†é’Ÿ
ç­¾åç¼“å­˜ï¼ˆå¿«é€Ÿæ”¹è¿›ï¼‰
    â†“ 1-2å¤©
JWT Tokenï¼ˆæœ€ä½³å®è·µï¼‰
```

---

## âœ… æœ€ç»ˆæ¨è

**å¯¹äºä½ çš„é¡¹ç›®ï¼ˆé¦™æ¸¯å‡å­¦åŠ©æ‰‹ï¼‰ï¼š**

### ğŸ¯ æ¨èæ–¹æ¡ˆï¼šJWT Token

**ç†ç”±ï¼š**
1. âœ… æ˜¯SPAåº”ç”¨ï¼ˆVueï¼‰- JWTå¤©ç„¶é€‚é…
2. âœ… éœ€è¦è‰¯å¥½æ€§èƒ½ - Tokenæ–¹æ¡ˆæœ€ä¼˜
3. âœ… æœªæ¥å¯èƒ½æœ‰APP - JWTè·¨å¹³å°
4. âœ… è¡Œä¸šæ ‡å‡† - æ˜“äºç»´æŠ¤

### ğŸ“‹ å®æ–½æ­¥éª¤

1. **ç¬¬1æ­¥ï¼šæ·»åŠ ç­¾åç¼“å­˜**ï¼ˆä»Šå¤©ï¼Œ30åˆ†é’Ÿï¼‰
   - ç«‹å³æ”¹å–„æ€§èƒ½
   - æ”¹åŠ¨æœ€å°

2. **ç¬¬2æ­¥ï¼šå®æ–½JWT Token**ï¼ˆæœ¬å‘¨ï¼Œ1-2å¤©ï¼‰
   - å½»åº•è§£å†³æ€§èƒ½é—®é¢˜
   - è¿ç§»åˆ°æœ€ä½³å®è·µ

3. **ç¬¬3æ­¥ï¼šç›‘æ§ä¼˜åŒ–**ï¼ˆæŒç»­ï¼‰
   - ç›‘æ§Tokenä½¿ç”¨æƒ…å†µ
   - è°ƒæ•´è¿‡æœŸæ—¶é—´
   - ä¼˜åŒ–åˆ·æ–°ç­–ç•¥

---

## ğŸ’¡ æ€»ç»“

**å›ç­”ä½ çš„é—®é¢˜ï¼š**

> "æ¯æ¬¡å‘è¯·æ±‚å‰éƒ½éœ€è¦è¯·æ±‚æœåŠ¡ç«¯è·å–ç­¾åä¿¡æ¯ï¼Œè¿™ä¸ªæ˜¯æœ€ä½³å®è·µå—ï¼Ÿ"

**ç­”æ¡ˆï¼šä¸æ˜¯ï¼**

âŒ **æ¯æ¬¡ç­¾å** - å®‰å…¨ä½†æ€§èƒ½å·®  
â­ **JWT Token** - å®‰å…¨ä¸”æ€§èƒ½å¥½ï¼Œæ˜¯ä¸šç•Œæœ€ä½³å®è·µ  
âš¡ **ç­¾åç¼“å­˜** - å¿«é€Ÿæ”¹è¿›æ–¹æ¡ˆ

**å»ºè®®ï¼šç«‹å³è¿ç§»åˆ°JWT Tokenæ–¹æ¡ˆï¼**

---

*éœ€è¦å¸®åŠ©å®æ–½JWT Tokenæ–¹æ¡ˆï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼*

