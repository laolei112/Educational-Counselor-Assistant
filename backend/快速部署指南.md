# 快速部署指南 - 小学中学分离

## 准备工作

确保以下文件已就位：
- ✅ `backend/backend/api/schools/secondary_views.py`
- ✅ `backend/backend/api/schools/urls.py`
- ✅ `backend/backend/models/tb_secondary_schools.py`
- ✅ `backend/import_secondary_schools.py`
- ✅ `backend/common/data/香港各中学信息.xlsx`

## 部署步骤

### 第一步：数据库迁移

```bash
cd /data/home/roylei/Educational-Counselor-Assistant/backend

# 生成迁移文件
python3 manage.py makemigrations

# 执行迁移
python3 manage.py migrate

# 验证表是否创建成功
python3 manage.py dbshell
# 在 MySQL shell 中执行：
# SHOW TABLES;
# DESC tb_secondary_schools;
# EXIT;
```

### 第二步：导入中学数据

```bash
# 确认 Excel 文件位置
ls -lh common/data/香港各中学信息.xlsx

# 运行导入脚本
python3 import_secondary_schools.py

# 等待导入完成，查看统计信息
```

### 第三步：测试后端接口

```bash
# 安装测试依赖
pip3 install requests

# 运行测试脚本
python3 test_secondary_api.py

# 如果所有测试通过，说明接口工作正常
```

### 第四步：重启服务

```bash
# 如果使用 supervisord
sudo supervisorctl restart backend

# 如果使用 Docker
docker-compose restart backend

# 如果直接运行
# 先停止现有进程，然后
python3 manage.py runserver 0.0.0.0:8000
```

### 第五步：验证接口

```bash
# 测试中学列表
curl "http://localhost:8000/api/schools/secondary?page=1&pageSize=5"

# 测试中学详情（假设 ID=1）
curl "http://localhost:8000/api/schools/secondary/1"

# 测试中学统计
curl "http://localhost:8000/api/schools/secondary/stats"

# 测试小学列表（确保不受影响）
curl "http://localhost:8000/api/schools/primary?page=1&pageSize=5"
```

## 预期结果

### 中学列表返回示例

```json
{
  "code": 200,
  "message": "成功",
  "success": true,
  "data": {
    "list": [
      {
        "id": 1,
        "name": "拔萃男书院",
        "type": "secondary",
        "district": "九龙城区",
        "schoolNet": "34, 35, 41",
        "religion": "基督教",
        "gender": "男",
        "tuition": "$59860",
        "category": "直资",
        "schoolGroup": "1B",
        "totalClasses": 36,
        "address": "九龙旺角亚皆老街131号",
        "phone": "27115191",
        "email": "dbsadmin@dbs.edu.hk",
        "website": "http://www.dbs.edu.hk"
      }
    ],
    "total": 500,
    "page": 1,
    "pageSize": 5,
    "totalPages": 100
  }
}
```

## 常见问题

### Q1: 数据库迁移失败

**错误**: `django.db.utils.OperationalError: (1050, "Table 'tb_secondary_schools' already exists")`

**解决**:
```bash
# 删除现有表（注意备份数据）
python3 manage.py dbshell
DROP TABLE IF EXISTS tb_secondary_schools;
EXIT;

# 重新迁移
python3 manage.py migrate --fake-initial
```

### Q2: 导入脚本找不到 Excel 文件

**错误**: `错误: 找不到 Excel 文件`

**解决**:
```bash
# 检查文件位置
find . -name "香港各中学信息.xlsx"

# 移动文件到正确位置
mv 香港各中学信息.xlsx backend/common/data/
```

### Q3: 接口返回 500 错误

**错误**: `服务器错误: Apps aren't loaded yet`

**解决**:
```bash
# 检查 models/__init__.py 文件
cat backend/backend/models/__init__.py

# 应该是空文件或只有注释，不能有 import 语句
# 如果有 import，删除它们

# 重启服务
sudo supervisorctl restart backend
```

### Q4: 接口返回空数据

**原因**: 数据未导入或导入失败

**解决**:
```bash
# 检查数据库中的记录数
python3 manage.py dbshell
SELECT COUNT(*) FROM tb_secondary_schools;
EXIT;

# 如果为 0，重新运行导入脚本
python3 import_secondary_schools.py
```

### Q5: 前端无法获取数据

**原因**: CORS 或网络问题

**解决**:
```bash
# 检查后端日志
tail -f log/backend.log

# 检查 Nginx 配置
cat /path/to/nginx.conf

# 确认后端服务正在运行
ps aux | grep python | grep manage.py
```

## 回滚步骤

如果需要回滚到之前的状态：

```bash
# 1. 删除新添加的表
python3 manage.py dbshell
DROP TABLE IF EXISTS tb_secondary_schools;
EXIT;

# 2. 恢复原来的 urls.py
git checkout backend/backend/api/schools/urls.py

# 3. 删除新添加的文件
rm backend/backend/api/schools/secondary_views.py
rm backend/backend/models/tb_secondary_schools.py

# 4. 重启服务
sudo supervisorctl restart backend
```

## 性能优化

### 添加索引

如果数据量大，可以添加更多索引：

```sql
-- 进入 MySQL
python3 manage.py dbshell

-- 添加联合索引
ALTER TABLE tb_secondary_schools 
ADD INDEX idx_district_group (district, school_group);

ALTER TABLE tb_secondary_schools 
ADD INDEX idx_category_gender (school_category, student_gender);

-- 查看索引
SHOW INDEX FROM tb_secondary_schools;
```

### 启用查询缓存

在 `settings.py` 中配置缓存：

```python
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.redis.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/1',
    }
}
```

## 监控和日志

### 查看日志

```bash
# 查看实时日志
tail -f log/backend.log

# 查看最近的错误
grep -i error log/backend.log | tail -20

# 查看访问日志
tail -f /var/log/nginx/access.log
```

### 监控接口性能

```bash
# 使用 curl 测试响应时间
time curl "http://localhost:8000/api/schools/secondary?page=1&pageSize=20"

# 使用 ab 进行压力测试
ab -n 1000 -c 10 "http://localhost:8000/api/schools/secondary?page=1&pageSize=20"
```

## 完成检查清单

部署完成后，请检查以下项目：

- [ ] 数据库表 `tb_secondary_schools` 已创建
- [ ] 中学数据已成功导入（至少有几百条记录）
- [ ] 中学列表接口返回正确数据
- [ ] 中学详情接口返回正确数据
- [ ] 中学统计接口返回正确数据
- [ ] 小学列表接口仍然正常工作
- [ ] 前端可以正常访问中学数据
- [ ] 关键词搜索功能正常
- [ ] 筛选功能正常（district, schoolGroup等）
- [ ] 分页功能正常
- [ ] 服务运行稳定，无错误日志

## 下一步

部署完成后：

1. **测试前端页面**
   - 访问中学列表页
   - 测试搜索功能
   - 测试筛选功能
   - 查看中学详情页

2. **性能优化**
   - 监控接口响应时间
   - 根据需要添加缓存
   - 优化数据库查询

3. **功能完善**
   - 完善中学课程设置数据
   - 添加更多筛选维度
   - 优化搜索算法

## 支持

如有问题，请查看：
- `小学中学接口分离说明.md` - 详细的接口说明
- `前后端小学中学分离完成总结.md` - 完整的改动总结
- `AppRegistryNotReady错误修复说明.md` - 常见错误解决方案

