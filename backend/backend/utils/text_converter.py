"""
简繁体转换工具
提供简体中文和繁体中文之间的转换功能
支持 OpenCC（如果已安装），否则使用内置字典
"""

# 尝试导入 OpenCC
try:
    from opencc import OpenCC
    _opencc_t2s = OpenCC('t2s')  # 繁体到简体
    _opencc_s2t = OpenCC('s2t')  # 简体到繁体
    USE_OPENCC = True
except ImportError:
    USE_OPENCC = False
    _opencc_t2s = None
    _opencc_s2t = None

# 繁体到简体映射表（常用字符，作为后备方案）
TRADITIONAL_TO_SIMPLIFIED = {
    # 基础汉字
    '書': '书', '學': '学', '國': '国', '華': '华', '聖': '圣', '爲': '为', '為': '为',
    '醫': '医', '會': '会', '義': '义', '寶': '宝', '協': '协', '慶': '庆', '銘': '铭',
    '賢': '贤', '紀': '纪', '劉': '刘', '張': '张', '陳': '陈', '楊': '杨', '黃': '黄',
    '趙': '赵', '鄭': '郑', '謝': '谢', '鍾': '钟', '陸': '陆', '餘': '余', '諸': '诸',
    '區': '区', '嶽': '岳', '樂': '乐', '藍': '蓝', '閻': '阎', '馬': '马', '盧': '卢',
    '傅': '傅', '蔣': '蒋', '蘇': '苏', '葉': '叶', '緣': '缘', '達': '达', '灣': '湾',
    '島': '岛', '門': '门', '東': '东', '貢': '贡', '護': '护', '譚': '谭', '鄧': '邓',
    '範': '范', '潘': '潘', '羅': '罗', '梁': '梁', '韋': '韦', '許': '许', '戴': '戴',
    '錢': '钱', '湯': '汤', '熊': '熊', '薛': '薛', '竇': '窦', '顧': '顾', '諾': '诺',
    '撒': '撒', '瑪': '玛', '麗': '丽', '伊': '伊', '利': '利', '沙': '沙', '伯': '伯',
    '啟': '启', '導': '导', '濟': '济', '衛': '卫', '勵': '励', '壇': '坛', '僑': '侨',
    '鄉': '乡', '廈': '厦', '廣': '广', '漢': '汉', '臺': '台', '澳': '澳', '糾': '纠',
    '紛': '纷',
    # 教育相关
    '敎': '教', '師': '师', '資': '资', '舘': '馆', '館': '馆', '圖': '图', '體': '体',
    '課': '课', '堂': '堂', '訓': '训', '練': '练', '術': '术', '藝': '艺', '員': '员',
    '園': '园', '齋': '斋', '齊': '齐', '獎': '奖', '勵': '励', '優': '优', '勝': '胜',
    # 宗教相关
    '天': '天', '主': '主', '敎': '教', '基': '基', '督': '督', '佛': '佛', '道': '道',
    '教': '教', '堂': '堂', '院': '院', '寺': '寺', '廟': '庙', '神': '神', '靈': '灵',
    '聖': '圣', '福': '福', '恩': '恩', '善': '善', '德': '德', '仁': '仁', '愛': '爱',
    # 机构相关
    '會': '会', '社': '社', '團': '团', '聯': '联', '總': '总', '公': '公', '立': '立',
    '私': '私', '官': '官', '政': '政', '府': '府', '部': '部', '局': '局', '署': '署',
    '處': '处', '科': '科', '組': '组', '委': '委', '議': '议', '辦': '办', '業': '业',
    # 常用动词
    '來': '来', '還': '还', '進': '进', '運': '运', '關': '关', '開': '开', '閉': '闭',
    '從': '从', '應': '应', '當': '当', '對': '对', '與': '与', '給': '给', '讓': '让',
    '説': '说', '話': '话', '語': '语', '詞': '词', '認': '认', '識': '识', '讀': '读',
    '寫': '写', '聽': '听', '見': '见', '觀': '观', '聞': '闻', '問': '问', '答': '答',
    # 常用形容词
    '長': '长', '強': '强', '舊': '旧', '新': '新', '輕': '轻', '重': '重', '遠': '远',
    '近': '近', '高': '高', '低': '低', '貴': '贵', '賤': '贱', '優': '优', '劣': '劣',
    '專': '专', '業': '业', '實': '实', '際': '际', '現': '现', '過': '过', '歷': '历',
    '傳': '传', '統': '统', '繼': '继', '續': '续', '斷': '断', '連': '连', '聯': '联',
    # 数量词
    '個': '个', '隻': '只', '雙': '双', '對': '对', '條': '条', '張': '张', '間': '间',
    '層': '层', '棟': '栋', '間': '间', '輛': '辆', '臺': '台',
    # 香港特有
    '灣': '湾', '島': '岛', '區': '区', '道': '道', '街': '街', '里': '里', '村': '村',
    '鄉': '乡', '坊': '坊', '徑': '径', '路': '路', '巷': '巷', '弄': '弄',
    '衞': '卫', '條': '条', '網': '网', '絡': '络', '稱': '称', '聯': '联', '繫': '系',
    '屬': '属', '結': '结', '龍': '龙',
}

# 简体到繁体映射表（反向映射）
SIMPLIFIED_TO_TRADITIONAL = {}
for trad, simp in TRADITIONAL_TO_SIMPLIFIED.items():
    # 只添加不重复的映射
    if simp not in SIMPLIFIED_TO_TRADITIONAL:
        SIMPLIFIED_TO_TRADITIONAL[simp] = trad
    # 对于一对多的情况，使用最常见的繁体字
    # 这里保持简单，优先使用已经映射的


def to_simplified(text):
    """
    繁体转简体
    :param text: 繁体中文文本
    :return: 简体中文文本
    """
    if not text:
        return text
    
    # 优先使用 OpenCC（如果可用）
    if USE_OPENCC and _opencc_t2s:
        try:
            return _opencc_t2s.convert(text)
        except Exception:
            # OpenCC 失败时回退到字典
            pass
    
    # 使用内置字典转换
    result = text
    for trad, simp in TRADITIONAL_TO_SIMPLIFIED.items():
        result = result.replace(trad, simp)
    return result


def to_traditional(text):
    """
    简体转繁体
    :param text: 简体中文文本
    :return: 繁体中文文本
    """
    if not text:
        return text
    
    # 优先使用 OpenCC（如果可用）
    if USE_OPENCC and _opencc_s2t:
        try:
            return _opencc_s2t.convert(text)
        except Exception:
            # OpenCC 失败时回退到字典
            pass
    
    # 使用内置字典转换
    result = text
    for simp, trad in SIMPLIFIED_TO_TRADITIONAL.items():
        result = result.replace(simp, trad)
    return result


def normalize_keyword(keyword):
    """
    标准化关键词：将关键词转换为简体，用于搜索
    这样可以同时匹配简体和繁体字段
    优先使用 OpenCC 进行转换（更准确），如果未安装则使用内置字典
    
    :param keyword: 用户输入的关键词（可能是简体或繁体）
    :return: 简体关键词
    """
    if not keyword:
        return keyword
    
    # 使用 OpenCC 或内置字典将繁体转为简体，统一格式用于搜索
    return to_simplified(keyword)

