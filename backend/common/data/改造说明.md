# 中学数据导入脚本改造说明

## 改造目标

根据 `import_schools_to_db.py` 的风格改造 `import_secondary_schools.py`，使其遵循项目的标准开发模式。

## 主要改动

### 1. 使用 Django ORM 替代原生 PyMySQL

**改造前**:
```python
import pymysql

connection = pymysql.connect(**db_config)
cursor = connection.cursor()
cursor.execute(insert_sql, school_data)
connection.commit()
```

**改造后**:
```python
import django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')
django.setup()

from backend.models.tb_secondary_schools import TbSecondarySchools

TbSecondarySchools.objects.create(**school_obj_data)
```

**优势**:
- ✓ 自动处理数据库连接和事务
- ✓ 类型安全，减少 SQL 注入风险
- ✓ 代码更简洁易读
- ✓ 与项目其他部分保持一致

### 2. 增加更新/创建逻辑

**改造前**:
- 只支持插入新记录
- 需要手动清空表

**改造后**:
```python
existing_school = TbSecondarySchools.objects.filter(school_name=school_name).first()

if existing_school:
    # 更新现有记录
    for key, value in school_obj_data.items():
        setattr(existing_school, key, value)
    existing_school.save()
    updated_count += 1
else:
    # 创建新记录
    TbSecondarySchools.objects.create(**school_obj_data)
    created_count += 1
```

**优势**:
- ✓ 支持重复运行脚本
- ✓ 自动去重，根据学校名称判断
- ✓ 可以更新已存在的数据

### 3. 增强统计功能

**改造前**:
```python
cursor.execute("SELECT COUNT(*) FROM tb_secondary_schools")
total_count = cursor.fetchone()[0]
```

**改造后**:
```python
# 总数统计
total_count = TbSecondarySchools.objects.count()

# 区域分布统计
districts = TbSecondarySchools.objects.values('district').annotate(
    count=django.db.models.Count('id')
).order_by('-count')[:10]

# 学校类别统计
categories = TbSecondarySchools.objects.values('school_category').annotate(
    count=django.db.models.Count('id')
).order_by('-count')
```

**优势**:
- ✓ 导入完成后自动显示详细统计
- ✓ 便于验证导入结果
- ✓ 帮助了解数据分布

### 4. 移除外部数据库配置依赖

**改造前**:
```python
from db_config import CURRENT_CONFIG
db_config = CURRENT_CONFIG
```

**改造后**:
```python
# 使用 Django settings
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')
```

**优势**:
- ✓ 统一使用项目配置
- ✓ 减少配置文件维护
- ✓ 避免配置不一致问题

## 新增文件

### 1. ORM 模型文件

**文件**: `backend/backend/models/tb_secondary_schools.py`

**内容**:
- 完整的 Django ORM 模型定义
- 包含所有字段定义和索引
- 提供实用方法：
  - `get_full_info()`: 获取完整信息
  - `is_band_one()`: 判断是否为 Band 1 学校
  - `is_coed()`: 判断是否为男女校

**特点**:
- 遵循 Django ORM 最佳实践
- 添加详细的注释和帮助文本
- 支持数据库迁移

### 2. 测试脚本

**文件**: `backend/common/data/test_secondary_schools_orm.py`

**功能**:
- 测试 ORM 模型是否正常工作
- 验证各种查询功能
- 测试模型方法

**使用**:
```bash
python3 test_secondary_schools_orm.py
```

### 3. 使用说明文档

**文件**: `backend/common/data/import_secondary_schools_README.md`

**内容**:
- 详细的使用说明
- ORM 模型使用示例
- 故障排除指南

## 代码结构对比

### import_schools_to_db.py 的结构

```
1. 导入依赖和初始化 Django
2. 定义数据映射函数（map_gender, map_category 等）
3. 定义数据处理函数（process_primary_schools, process_secondary_schools）
4. 主函数协调整体流程
```

### 改造后的 import_secondary_schools.py 结构

```
1. 导入依赖和初始化 Django ✓
2. 定义数据清理函数（clean_value, parse_phone）✓
3. 定义数据处理函数（import_secondary_schools_from_excel）✓
4. 主函数协调整体流程，包含详细统计 ✓
```

**一致性**: 完全遵循了原有脚本的结构和风格

## 数据库表结构

### 与原 SQL 脚本一致

ORM 模型字段与 `tb_secondary_schools.sql` 中定义的字段完全对应：

| SQL 字段 | ORM 字段 | 类型一致 |
|---------|---------|---------|
| school_name | school_name | ✓ VARCHAR(100) |
| district | district | ✓ VARCHAR(50) |
| school_net | school_net | ✓ VARCHAR(50) |
| religion | religion | ✓ VARCHAR(50) |
| student_gender | student_gender | ✓ VARCHAR(20) |
| tuition | tuition | ✓ VARCHAR(200) |
| school_category | school_category | ✓ VARCHAR(50) |
| school_group | school_group | ✓ VARCHAR(20) |
| transfer_open_time | transfer_open_time | ✓ VARCHAR(100) |
| total_classes | total_classes | ✓ INT |
| admission_info | admission_info | ✓ TEXT |
| school_curriculum | school_curriculum | ✓ TEXT |
| address | address | ✓ VARCHAR(200) |
| phone | phone | ✓ VARCHAR(20) |
| email | email | ✓ VARCHAR(100) |
| website | website | ✓ VARCHAR(200) |

### 索引配置一致

ORM 模型中的索引与 SQL 脚本中的索引定义完全一致。

## 使用流程

### 1. 数据库迁移

```bash
cd /Users/roylei/projects/Educational-Counselor-Assistant/backend
python manage.py makemigrations
python manage.py migrate
```

### 2. 运行导入脚本

```bash
cd /Users/roylei/projects/Educational-Counselor-Assistant/backend/common/data
python3 import_secondary_schools.py
```

### 3. 验证导入结果

```bash
python3 test_secondary_schools_orm.py
```

## 优势总结

1. **代码质量**: 使用 ORM 提高了代码的可维护性和安全性
2. **一致性**: 与项目其他部分保持一致的开发风格
3. **可重用性**: ORM 模型可以在项目其他地方使用
4. **健壮性**: 支持更新操作，可以重复运行
5. **可测试性**: 提供了测试脚本验证功能

## 注意事项

1. 首次运行需要先执行数据库迁移
2. Excel 文件需要放在 `backend/common/data/` 目录下
3. 课程设置字段（school_curriculum）暂时不导入
4. 脚本会自动处理重复数据（根据学校名称去重）

## 后续建议

1. 可以添加命令行参数支持（如指定 Excel 文件路径）
2. 可以添加数据验证逻辑（如电话号码格式验证）
3. 可以考虑使用 bulk_create 优化批量插入性能
4. 可以添加日志记录功能

