# 中学课程设置功能说明

## 功能概述

从 Excel 文件中提取中学的课程信息（中文授课和英文授课的科目），存储到数据库，并在学校详情页用表格形式展示。

## 数据格式

### 存储格式
```json
{
  "中文授课": ["中国语文", "中史", "公民与社会发展科", "体育"],
  "英文授课": ["英国语文", "数学", "物理", "化学", "生物", "经济"]
}
```

### 数据来源
- Excel 文件：`common/data/香港各中学信息.xlsx`
- 列名：
  - `以中文为教学语言_中四至中六`
  - `以英文为教学语言_中四至中六`

## 实现步骤

### 1. 数据处理脚本

创建了 `update_school_curriculum.py` 脚本来处理数据：

**功能：**
- 读取 Excel 文件
- 解析课程数据（用 `、` 分隔科目）
- 忽略 `<br>` 后的非 DSE 课程
- 生成 JSON 格式数据
- 更新到数据库 `school_curriculum` 字段

**使用方法：**
```bash
cd /Users/roylei/projects/Educational-Counselor-Assistant/backend
python common/data/update_school_curriculum.py
```

**脚本特点：**
- 自动解析科目列表
- 处理空值情况
- 显示前10条详细信息
- 统计更新结果
- 验证数据正确性

### 2. 后端API更新

修改了 `secondary_views.py` 的序列化函数：

```python
def serialize_secondary_school(school):
    # 解析课程数据
    curriculum_data = None
    if school.school_curriculum:
        try:
            curriculum_data = json.loads(school.school_curriculum)
        except:
            curriculum_data = None
    
    return {
        ...
        "schoolCurriculum": curriculum_data,  # 返回解析后的对象
        ...
    }
```

**改进：**
- 将 JSON 字符串解析为对象
- 处理解析异常
- 返回 `null` 而不是错误字符串

### 3. 前端表格展示

在 `SchoolDetailModal.vue` 中添加了课程设置表格：

**位置：**
- 在"中一入学信息"之后
- 在"联络信息"之前

**HTML结构：**
```vue
<section v-if="school.type === 'secondary' && school.schoolCurriculum" class="curriculum">
  <h3>📚 中四至中六课程设置（DSE）</h3>
  <div class="curriculum-table-wrapper">
    <table class="curriculum-table">
      <thead>
        <tr>
          <th>授课语言</th>
          <th>科目</th>
          <th>科目数</th>
        </tr>
      </thead>
      <tbody>
        <tr><!-- 中文授课 --></tr>
        <tr><!-- 英文授课 --></tr>
      </tbody>
    </table>
  </div>
</section>
```

## 表格设计

### 表格结构

| 授课语言 | 科目 | 科目数 |
|---------|------|--------|
| 中文授课 | 中国语文、中史、公民与社会发展科、体育 | 4 |
| 英文授课 | 英国语文、数学、物理、化学、生物、经济、资讯及通讯科技 | 7 |

### 列宽设置
- **授课语言列**：100px（固定宽度）
- **科目列**：自适应（最大500px）
- **科目数列**：80px，居中显示

### 样式特点

#### 表头
```css
background: #f8f9fa;  /* 浅灰背景 */
font-weight: 600;     /* 粗体 */
color: #495057;       /* 深灰文字 */
border: 1px solid #dee2e6;  /* 边框 */
```

#### 单元格
```css
padding: 12px;
border: 1px solid #dee2e6;
vertical-align: top;  /* 顶部对齐 */
```

#### 悬停效果
```css
tbody tr:hover {
  background: #f8f9fa;  /* 行悬停高亮 */
}
```

#### 科目数显示
```css
text-align: center;
font-weight: 600;
color: #007bff;  /* 蓝色，突出显示 */
```

## 数据示例

### 拔萃男书院
```json
{
  "中文授课": [
    "中国语文",
    "中史",
    "体育（香港中学文凭考试）",
    "初级中国语文"
  ],
  "英文授课": [
    "英国语文",
    "数学",
    "数学伸延单元1及2",
    "生物",
    "化学",
    "物理",
    "资讯及通讯科技",
    "设计与应用科技",
    "音乐",
    "经济"
  ]
}
```

### 保良局罗杰承中学
```json
{
  "中文授课": [
    "中国语文",
    "中史",
    "公民与社会发展科",
    "体育及视觉艺术"
  ],
  "英文授课": [
    "英国语文",
    "数学",
    "物理",
    "化学",
    "生物",
    "地理",
    "经济",
    "资讯及通讯科技",
    "企业、会计与财务概论"
  ]
}
```

## 显示效果

### 完整展示流程
```
学校详情弹窗
├─ 📋 基本信息
├─ ❤️ 学校特色（如有）
├─ 📝 中一入学信息（仅中学，如有）
├─ 📚 中四至中六课程设置（DSE）  ← 新增
│   └─ 表格展示中文/英文授课科目
└─ 📞 联络信息
```

### 表格显示示例
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📚 中四至中六课程设置（DSE）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
┌──────────┬─────────────────────────────┬────────┐
│ 授课语言 │ 科目                        │ 科目数 │
├──────────┼─────────────────────────────┼────────┤
│ 中文授课 │ 中国语文、中史、公民与社会  │   4    │
│          │ 发展科、体育                │        │
├──────────┼─────────────────────────────┼────────┤
│ 英文授课 │ 英国语文、数学、物理、化学、│   7    │
│          │ 生物、经济、资讯及通讯科技  │        │
└──────────┴─────────────────────────────┴────────┘
```

## 数据处理规则

### 科目分隔
```python
subjects = [s.strip() for s in subject_str.split('、') if s.strip()]
```

### 忽略非DSE课程
```python
if '<br>' in subject_str:
    subject_str = subject_str.split('<br>')[0]
```

**示例：**
```
原始数据：
"中国语文、中史、体育<br>非DSE课程：XXX"

处理后：
["中国语文", "中史", "体育"]
```

### 空值处理
- 如果两列都为空，不更新该学校数据
- 如果只有一列有数据，另一列为空数组 `[]`

## 条件显示

### 显示条件
表格只在以下条件**都**满足时显示：
1. ✅ 学校类型为中学（`school.type === 'secondary'`）
2. ✅ 有课程数据（`school.schoolCurriculum` 存在）
3. ✅ 至少有一种授课语言有科目

### 行显示条件
- 中文授课行：`中文授课` 数组存在且长度 > 0
- 英文授课行：`英文授课` 数组存在且长度 > 0

## 响应式设计

### 桌面端
- 表格正常显示
- 列宽合理分配
- 科目列最大宽度 500px

### 移动端
```css
.curriculum-table-wrapper {
  overflow-x: auto;  /* 横向滚动 */
}
```

- 表格可横向滚动
- 保持完整的表格结构
- 避免内容挤压

## 数据库字段

### 字段定义
```python
school_curriculum = models.TextField(
    blank=True,
    null=True,
    verbose_name='课程设置',
    help_text='学校课程设置详情'
)
```

### 数据类型
- **存储**：JSON 字符串
- **API 返回**：解析后的对象
- **前端使用**：JavaScript 对象

## 执行步骤

### 1. 运行数据处理脚本
```bash
cd backend
python common/data/update_school_curriculum.py
```

**输出示例：**
```
正在读取 Excel 文件: .../香港各中学信息.xlsx
共读取 468 条学校数据

开始处理课程数据...

1. 拔萃男书院
   中文授课科目（4）: 中国语文、中史、体育（香港中学文凭考试） ...
   英文授课科目（10）: 英国语文、数学、数学伸延单元1及2 ...
   JSON: {"中文授课": ["中国语文", "中史", ...

============================================================
数据库更新结果:
============================================================
成功更新: 450 所学校
未找到: 10 所学校
无课程数据: 8 所学校
总计: 468 所学校
============================================================
```

### 2. 验证数据
脚本会自动验证前5条数据：
```
验证更新结果（前5条）:
============================================================

拔萃男书院:
  中文授课: 4 科
  英文授课: 10 科

拔萃女书院:
  中文授课: 3 科
  英文授课: 8 科
```

### 3. 重启后端服务
```bash
# 如果使用 Docker
docker-compose restart backend

# 或者直接重启
./start.sh
```

### 4. 查看前端效果
1. 打开学校列表页
2. 点击任一中学卡片
3. 查看详情页的"中四至中六课程设置"部分

## 优势

### 数据完整性
1. ✅ 保留原始科目名称
2. ✅ 区分中英文授课
3. ✅ 统计科目数量
4. ✅ 忽略非 DSE 课程

### 可读性
1. ✅ 表格形式清晰直观
2. ✅ 科目用顿号分隔
3. ✅ 科目数蓝色突出显示
4. ✅ 行悬停效果

### 可维护性
1. ✅ JSON 格式易于扩展
2. ✅ 脚本可重复运行
3. ✅ 数据验证机制
4. ✅ 异常处理完善

## 未来扩展

### 可能的增强功能
1. **科目筛选** - 按科目筛选学校
2. **科目统计** - 显示最热门科目
3. **科目对比** - 对比不同学校的科目设置
4. **科目详情** - 点击科目显示更多信息
5. **导出功能** - 导出课程表为 PDF/Excel

### 数据增强
可以考虑添加：
- 每个科目的学分
- 选修/必修标记
- 科目的开课时间
- 任课教师信息

## 相关文件

**后端：**
- `backend/common/data/update_school_curriculum.py` - 数据处理脚本
- `backend/backend/api/schools/secondary_views.py` - API 序列化
- `backend/backend/models/tb_secondary_schools.py` - 数据模型

**前端：**
- `frontend/src/components/SchoolDetailModal.vue` - 详情组件
- `frontend/src/types/school.ts` - TypeScript 类型

**数据：**
- `backend/common/data/香港各中学信息.xlsx` - 源数据

## 总结

此功能实现了从 Excel 到数据库再到前端展示的完整数据流，用户可以清晰地看到每所中学在中四至中六阶段开设的 DSE 课程，以及这些课程是用中文还是英文授课。

表格设计简洁专业，与其他信息模块风格统一，为家长选择学校提供了重要的参考信息。

