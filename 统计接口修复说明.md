# ç»Ÿè®¡æ¥å£ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

é”™è¯¯ä¿¡æ¯ï¼š
```
æœåŠ¡å™¨é”™è¯¯: Cannot resolve keyword 'transfer_info' into field. 
Choices are: address, application_status, category, created_at, district, 
gender, id, level, name, net_name, official_website, promotion_rate, 
religion, remarks, teaching_language, tuition, updated_at, url
```

## ğŸ” é—®é¢˜åŸå› 

### 1. æ•°æ®åº“è¡¨åˆ†ç¦»
- åŸæ¥ä½¿ç”¨ç»Ÿä¸€çš„ `tb_schools` è¡¨å­˜å‚¨æ‰€æœ‰å­¦æ ¡
- ç°å·²åˆ†ç¦»ä¸ºä¸“ç”¨è¡¨ï¼š
  - `tb_primary_schools` - å°å­¦ä¸“ç”¨è¡¨
  - `tb_secondary_schools` - ä¸­å­¦ä¸“ç”¨è¡¨
- æ—§çš„ `tb_schools` è¡¨å·²åºŸå¼ƒ

### 2. å­—æ®µä¸åŒ¹é…
- æ–°è¡¨æœ‰ `transfer_info` JSON å­—æ®µ
- æ—§è¡¨ `tb_schools` æ²¡æœ‰è¿™ä¸ªå­—æ®µ
- `schools_stats` å‡½æ•°ä»åœ¨æŸ¥è¯¢æ—§è¡¨ï¼Œå°è¯•è®¿é—® `transfer_info` å­—æ®µå¯¼è‡´æŠ¥é”™

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶ï¼š`backend/backend/api/schools/views.py`

#### 1. å¯¼å…¥æ–°çš„æ¨¡å‹ç±»

**ä¿®æ”¹å‰**:
```python
from backend.models.tb_schools import TbSchools
```

**ä¿®æ”¹å**:
```python
from backend.models.tb_schools import TbSchools
from backend.models.tb_primary_schools import TbPrimarySchools
from backend.models.tb_secondary_schools import TbSecondarySchools
```

#### 2. ä¿®æ”¹ `schools_stats` å‡½æ•°

**ä¿®æ”¹å‰**:
```python
def schools_stats(request):
    queryset = TbSchools.objects.all()
    if school_type:
        queryset = queryset.filter(level=school_type)
    
    # å°è¯•è®¿é—®ä¸å­˜åœ¨çš„ transfer_info å­—æ®µ
    open_applications = queryset.filter(
        transfer_info__icontains='"application_status":"open"'
    ).count()
```

**ä¿®æ”¹å**:
```python
def schools_stats(request):
    school_type = request.GET.get('type')
    
    # æ ¹æ®ç±»å‹é€‰æ‹©ä¸åŒçš„æ•°æ®åº“è¡¨
    if school_type == 'primary':
        # æŸ¥è¯¢å°å­¦è¡¨
        queryset = TbPrimarySchools.objects.all()
        # ... å°å­¦ç»Ÿè®¡é€»è¾‘
        
    elif school_type == 'secondary':
        # æŸ¥è¯¢ä¸­å­¦è¡¨
        queryset = TbSecondarySchools.objects.all()
        # ... ä¸­å­¦ç»Ÿè®¡é€»è¾‘
        
    else:
        # åˆå¹¶ç»Ÿè®¡
        primary_count = TbPrimarySchools.objects.count()
        secondary_count = TbSecondarySchools.objects.count()
```

#### 3. åˆ é™¤åºŸå¼ƒçš„ `primary_schools_list` å‡½æ•°

æ­¤å‡½æ•°å·²è¢« `primary_views.primary_schools_list` å–ä»£ï¼Œå› æ­¤åˆ é™¤äº†æ—§å®ç°ã€‚

## ğŸ“Š æ–°çš„ç»Ÿè®¡æ¥å£é€»è¾‘

### å°å­¦ç»Ÿè®¡ (`type=primary`)

```python
queryset = TbPrimarySchools.objects.all()
total_schools = queryset.count()

# å¼€æ”¾ç”³è¯·æ•°é‡
open_applications = queryset.filter(
    transfer_info__icontains='"application_status":"open"'
).count() if queryset.filter(transfer_info__isnull=False).exists() else 0

# æŒ‰åœ°åŒºç»Ÿè®¡
district_stats = {}
# æŒ‰åˆ†ç±»ç»Ÿè®¡
category_stats = {}
```

**è¿”å›æ•°æ®**:
```json
{
  "totalSchools": 100,
  "openApplications": 10,
  "districtStats": { "ä¸­è¥¿åŒº": 20, "æ¹¾ä»”åŒº": 15, ... },
  "categoryStats": { "èµ„åŠ©": 60, "ç›´èµ„": 20, "ç§ç«‹": 20 }
}
```

### ä¸­å­¦ç»Ÿè®¡ (`type=secondary`)

```python
queryset = TbSecondarySchools.objects.all()
total_schools = queryset.count()

# å¼€æ”¾ç”³è¯·æ•°é‡
open_applications = queryset.filter(
    transfer_info__icontains='"application_status":"open"'
).count() if queryset.filter(transfer_info__isnull=False).exists() else 0

# æŒ‰åœ°åŒºç»Ÿè®¡
district_stats = {}
# æŒ‰åˆ†ç±»ç»Ÿè®¡
category_stats = {}
# æŒ‰ç»„åˆ«ç»Ÿè®¡ï¼ˆä¸­å­¦ç‰¹æœ‰ï¼‰
group_stats = {}
```

**è¿”å›æ•°æ®**:
```json
{
  "totalSchools": 150,
  "openApplications": 5,
  "districtStats": { "ä¸­è¥¿åŒº": 10, "ä¹é¾™åŸåŒº": 25, ... },
  "categoryStats": { "èµ„åŠ©": 80, "ç›´èµ„": 40, "ç§ç«‹": 30 },
  "groupStats": { "Band 1A": 30, "Band 1B": 40, ... }
}
```

### æ— ç±»å‹å‚æ•°ï¼ˆåˆå¹¶ç»Ÿè®¡ï¼‰

```python
primary_count = TbPrimarySchools.objects.count()
secondary_count = TbSecondarySchools.objects.count()
total_schools = primary_count + secondary_count
```

**è¿”å›æ•°æ®**:
```json
{
  "totalSchools": 250,
  "openApplications": 0,
  "typeStats": {
    "primary": 100,
    "secondary": 150
  },
  "districtStats": {},
  "categoryStats": {}
}
```

## ğŸ”„ API ä½¿ç”¨æ–¹å¼

### æ–¹å¼ 1ï¼šä½¿ç”¨é€šç”¨ç»Ÿè®¡æ¥å£ï¼ˆå·²ä¿®å¤ï¼‰

```bash
# å°å­¦ç»Ÿè®¡
GET /api/schools/stats?type=primary

# ä¸­å­¦ç»Ÿè®¡
GET /api/schools/stats?type=secondary

# å…¨éƒ¨ç»Ÿè®¡
GET /api/schools/stats
```

### æ–¹å¼ 2ï¼šä½¿ç”¨ä¸“ç”¨ç»Ÿè®¡æ¥å£ï¼ˆæ¨èï¼‰

```bash
# å°å­¦ç»Ÿè®¡ï¼ˆæ›´è¯¦ç»†ï¼‰
GET /api/schools/primary/stats/

# ä¸­å­¦ç»Ÿè®¡ï¼ˆæ›´è¯¦ç»†ï¼‰
GET /api/schools/secondary/stats/
```

## ğŸ“ ä»£ç æ¸…ç†

### åˆ é™¤çš„å‡½æ•°
- âŒ `primary_schools_list` - å·²è¿ç§»åˆ° `primary_views.py`

### åºŸå¼ƒä½†ä¿ç•™çš„å‡½æ•°
- âš ï¸ `schools_list` - ä½¿ç”¨æ—§è¡¨ï¼Œå»ºè®®ä½¿ç”¨ä¸“ç”¨æ¥å£
- âš ï¸ `school_detail` - ä½¿ç”¨æ—§è¡¨ï¼Œå»ºè®®ä½¿ç”¨ä¸“ç”¨æ¥å£
- âœ… `schools_stats` - å·²ä¿®å¤ï¼Œæ”¯æŒæ–°è¡¨

### å½“å‰å¯ç”¨çš„æ¥å£

#### é€šç”¨æ¥å£ï¼ˆä½¿ç”¨æ—§è¡¨ tb_schoolsï¼‰
```
GET /api/schools/          - å­¦æ ¡åˆ—è¡¨ï¼ˆå·²åºŸå¼ƒï¼‰
GET /api/schools/{id}/     - å­¦æ ¡è¯¦æƒ…ï¼ˆå·²åºŸå¼ƒï¼‰
GET /api/schools/stats     - ç»Ÿè®¡ä¿¡æ¯ï¼ˆå·²ä¿®å¤ï¼‰
```

#### å°å­¦ä¸“ç”¨æ¥å£ï¼ˆä½¿ç”¨ tb_primary_schoolsï¼‰
```
GET /api/schools/primary/           - å°å­¦åˆ—è¡¨ âœ…
GET /api/schools/primary/{id}/      - å°å­¦è¯¦æƒ… âœ…
GET /api/schools/primary/stats/     - å°å­¦ç»Ÿè®¡ âœ…
GET /api/schools/primary/filters/   - ç­›é€‰é€‰é¡¹ âœ…
```

#### ä¸­å­¦ä¸“ç”¨æ¥å£ï¼ˆä½¿ç”¨ tb_secondary_schoolsï¼‰
```
GET /api/schools/secondary/         - ä¸­å­¦åˆ—è¡¨ âœ…
GET /api/schools/secondary/{id}/    - ä¸­å­¦è¯¦æƒ… âœ…
GET /api/schools/secondary/stats/   - ä¸­å­¦ç»Ÿè®¡ âœ…
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. æµ‹è¯•å°å­¦ç»Ÿè®¡
```bash
curl http://localhost:8080/api/schools/stats?type=primary
```

**é¢„æœŸè¾“å‡º**:
```json
{
  "code": 200,
  "success": true,
  "data": {
    "totalSchools": 100,
    "openApplications": 10,
    "districtStats": { ... },
    "categoryStats": { ... }
  }
}
```

### 2. æµ‹è¯•ä¸­å­¦ç»Ÿè®¡
```bash
curl http://localhost:8080/api/schools/stats?type=secondary
```

**é¢„æœŸè¾“å‡º**:
```json
{
  "code": 200,
  "success": true,
  "data": {
    "totalSchools": 150,
    "openApplications": 5,
    "districtStats": { ... },
    "categoryStats": { ... },
    "groupStats": { ... }
  }
}
```

### 3. æµ‹è¯•åˆå¹¶ç»Ÿè®¡
```bash
curl http://localhost:8080/api/schools/stats
```

**é¢„æœŸè¾“å‡º**:
```json
{
  "code": 200,
  "success": true,
  "data": {
    "totalSchools": 250,
    "openApplications": 0,
    "typeStats": {
      "primary": 100,
      "secondary": 150
    },
    "districtStats": {},
    "categoryStats": {}
  }
}
```

## ğŸ“‚ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### åç«¯
- âœ… `backend/backend/api/schools/views.py`
  - å¯¼å…¥æ–°æ¨¡å‹ç±»
  - ä¿®æ”¹ `schools_stats` å‡½æ•°æ ¹æ® type æŸ¥è¯¢ä¸åŒè¡¨
  - åˆ é™¤åºŸå¼ƒçš„ `primary_schools_list` å‡½æ•°

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿ç§»**ï¼šç¡®ä¿å·²æ‰§è¡Œ ALTER è¯­å¥æ·»åŠ  `transfer_info` å’Œ `promotion_info` å­—æ®µ
2. **æœåŠ¡é‡å¯**ï¼šä¿®æ”¹åéœ€è¦é‡å¯åç«¯æœåŠ¡
3. **å‰ç«¯å…¼å®¹**ï¼šå‰ç«¯è°ƒç”¨ `/api/schools/stats` éœ€è¦ä¼ é€’ `type` å‚æ•°
4. **æ¨èä½¿ç”¨**ï¼šå»ºè®®å‰ç«¯æ”¹ç”¨ä¸“ç”¨ç»Ÿè®¡æ¥å£ï¼ˆ`/api/schools/primary/stats/` å’Œ `/api/schools/secondary/stats/`ï¼‰

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

1. **å®Œå…¨åºŸå¼ƒé€šç”¨æ¥å£**
   - ç§»é™¤ `schools_list` å’Œ `school_detail`
   - å‰ç«¯å®Œå…¨æ”¹ç”¨ä¸“ç”¨æ¥å£

2. **ç»Ÿä¸€ç»Ÿè®¡æ¥å£**
   - è€ƒè™‘å°† `schools_stats` ä¹ŸåºŸå¼ƒ
   - ç»Ÿä¸€ä½¿ç”¨ä¸“ç”¨ç»Ÿè®¡æ¥å£

3. **åˆ é™¤æ—§è¡¨**
   - ç¡®è®¤æ‰€æœ‰åŠŸèƒ½è¿ç§»å®Œæˆå
   - åˆ é™¤ `tb_schools` è¡¨

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-19  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: â³ å¾…éªŒè¯

