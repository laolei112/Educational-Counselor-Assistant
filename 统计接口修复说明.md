# 统计接口修复说明

## 🐛 问题描述

错误信息：
```
服务器错误: Cannot resolve keyword 'transfer_info' into field. 
Choices are: address, application_status, category, created_at, district, 
gender, id, level, name, net_name, official_website, promotion_rate, 
religion, remarks, teaching_language, tuition, updated_at, url
```

## 🔍 问题原因

### 1. 数据库表分离
- 原来使用统一的 `tb_schools` 表存储所有学校
- 现已分离为专用表：
  - `tb_primary_schools` - 小学专用表
  - `tb_secondary_schools` - 中学专用表
- 旧的 `tb_schools` 表已废弃

### 2. 字段不匹配
- 新表有 `transfer_info` JSON 字段
- 旧表 `tb_schools` 没有这个字段
- `schools_stats` 函数仍在查询旧表，尝试访问 `transfer_info` 字段导致报错

## ✅ 修复方案

### 修改文件：`backend/backend/api/schools/views.py`

#### 1. 导入新的模型类

**修改前**:
```python
from backend.models.tb_schools import TbSchools
```

**修改后**:
```python
from backend.models.tb_schools import TbSchools
from backend.models.tb_primary_schools import TbPrimarySchools
from backend.models.tb_secondary_schools import TbSecondarySchools
```

#### 2. 修改 `schools_stats` 函数

**修改前**:
```python
def schools_stats(request):
    queryset = TbSchools.objects.all()
    if school_type:
        queryset = queryset.filter(level=school_type)
    
    # 尝试访问不存在的 transfer_info 字段
    open_applications = queryset.filter(
        transfer_info__icontains='"application_status":"open"'
    ).count()
```

**修改后**:
```python
def schools_stats(request):
    school_type = request.GET.get('type')
    
    # 根据类型选择不同的数据库表
    if school_type == 'primary':
        # 查询小学表
        queryset = TbPrimarySchools.objects.all()
        # ... 小学统计逻辑
        
    elif school_type == 'secondary':
        # 查询中学表
        queryset = TbSecondarySchools.objects.all()
        # ... 中学统计逻辑
        
    else:
        # 合并统计
        primary_count = TbPrimarySchools.objects.count()
        secondary_count = TbSecondarySchools.objects.count()
```

#### 3. 删除废弃的 `primary_schools_list` 函数

此函数已被 `primary_views.primary_schools_list` 取代，因此删除了旧实现。

## 📊 新的统计接口逻辑

### 小学统计 (`type=primary`)

```python
queryset = TbPrimarySchools.objects.all()
total_schools = queryset.count()

# 开放申请数量
open_applications = queryset.filter(
    transfer_info__icontains='"application_status":"open"'
).count() if queryset.filter(transfer_info__isnull=False).exists() else 0

# 按地区统计
district_stats = {}
# 按分类统计
category_stats = {}
```

**返回数据**:
```json
{
  "totalSchools": 100,
  "openApplications": 10,
  "districtStats": { "中西区": 20, "湾仔区": 15, ... },
  "categoryStats": { "资助": 60, "直资": 20, "私立": 20 }
}
```

### 中学统计 (`type=secondary`)

```python
queryset = TbSecondarySchools.objects.all()
total_schools = queryset.count()

# 开放申请数量
open_applications = queryset.filter(
    transfer_info__icontains='"application_status":"open"'
).count() if queryset.filter(transfer_info__isnull=False).exists() else 0

# 按地区统计
district_stats = {}
# 按分类统计
category_stats = {}
# 按组别统计（中学特有）
group_stats = {}
```

**返回数据**:
```json
{
  "totalSchools": 150,
  "openApplications": 5,
  "districtStats": { "中西区": 10, "九龙城区": 25, ... },
  "categoryStats": { "资助": 80, "直资": 40, "私立": 30 },
  "groupStats": { "Band 1A": 30, "Band 1B": 40, ... }
}
```

### 无类型参数（合并统计）

```python
primary_count = TbPrimarySchools.objects.count()
secondary_count = TbSecondarySchools.objects.count()
total_schools = primary_count + secondary_count
```

**返回数据**:
```json
{
  "totalSchools": 250,
  "openApplications": 0,
  "typeStats": {
    "primary": 100,
    "secondary": 150
  },
  "districtStats": {},
  "categoryStats": {}
}
```

## 🔄 API 使用方式

### 方式 1：使用通用统计接口（已修复）

```bash
# 小学统计
GET /api/schools/stats?type=primary

# 中学统计
GET /api/schools/stats?type=secondary

# 全部统计
GET /api/schools/stats
```

### 方式 2：使用专用统计接口（推荐）

```bash
# 小学统计（更详细）
GET /api/schools/primary/stats/

# 中学统计（更详细）
GET /api/schools/secondary/stats/
```

## 📝 代码清理

### 删除的函数
- ❌ `primary_schools_list` - 已迁移到 `primary_views.py`

### 废弃但保留的函数
- ⚠️ `schools_list` - 使用旧表，建议使用专用接口
- ⚠️ `school_detail` - 使用旧表，建议使用专用接口
- ✅ `schools_stats` - 已修复，支持新表

### 当前可用的接口

#### 通用接口（使用旧表 tb_schools）
```
GET /api/schools/          - 学校列表（已废弃）
GET /api/schools/{id}/     - 学校详情（已废弃）
GET /api/schools/stats     - 统计信息（已修复）
```

#### 小学专用接口（使用 tb_primary_schools）
```
GET /api/schools/primary/           - 小学列表 ✅
GET /api/schools/primary/{id}/      - 小学详情 ✅
GET /api/schools/primary/stats/     - 小学统计 ✅
GET /api/schools/primary/filters/   - 筛选选项 ✅
```

#### 中学专用接口（使用 tb_secondary_schools）
```
GET /api/schools/secondary/         - 中学列表 ✅
GET /api/schools/secondary/{id}/    - 中学详情 ✅
GET /api/schools/secondary/stats/   - 中学统计 ✅
```

## 🧪 测试验证

### 1. 测试小学统计
```bash
curl http://localhost:8080/api/schools/stats?type=primary
```

**预期输出**:
```json
{
  "code": 200,
  "success": true,
  "data": {
    "totalSchools": 100,
    "openApplications": 10,
    "districtStats": { ... },
    "categoryStats": { ... }
  }
}
```

### 2. 测试中学统计
```bash
curl http://localhost:8080/api/schools/stats?type=secondary
```

**预期输出**:
```json
{
  "code": 200,
  "success": true,
  "data": {
    "totalSchools": 150,
    "openApplications": 5,
    "districtStats": { ... },
    "categoryStats": { ... },
    "groupStats": { ... }
  }
}
```

### 3. 测试合并统计
```bash
curl http://localhost:8080/api/schools/stats
```

**预期输出**:
```json
{
  "code": 200,
  "success": true,
  "data": {
    "totalSchools": 250,
    "openApplications": 0,
    "typeStats": {
      "primary": 100,
      "secondary": 150
    },
    "districtStats": {},
    "categoryStats": {}
  }
}
```

## 📂 修改文件清单

### 后端
- ✅ `backend/backend/api/schools/views.py`
  - 导入新模型类
  - 修改 `schools_stats` 函数根据 type 查询不同表
  - 删除废弃的 `primary_schools_list` 函数

## ⚠️ 注意事项

1. **数据库迁移**：确保已执行 ALTER 语句添加 `transfer_info` 和 `promotion_info` 字段
2. **服务重启**：修改后需要重启后端服务
3. **前端兼容**：前端调用 `/api/schools/stats` 需要传递 `type` 参数
4. **推荐使用**：建议前端改用专用统计接口（`/api/schools/primary/stats/` 和 `/api/schools/secondary/stats/`）

## 🔄 后续优化建议

1. **完全废弃通用接口**
   - 移除 `schools_list` 和 `school_detail`
   - 前端完全改用专用接口

2. **统一统计接口**
   - 考虑将 `schools_stats` 也废弃
   - 统一使用专用统计接口

3. **删除旧表**
   - 确认所有功能迁移完成后
   - 删除 `tb_schools` 表

---

**修复完成时间**: 2025-10-19  
**修复状态**: ✅ 已完成  
**测试状态**: ⏳ 待验证

